<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>Aplikasi Adzan Al-Muthmainnah</title>
  <link rel="icon" href="data:,">
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">

  <script src="stb-compatibility.js"></script>
  <script src="stb-optimizer.js"></script>
  <!-- Sertakan prayTimes.js secara lokal -->
  <script src="prayTimes.js"></script>
  <script src="hijri-calendar.js"></script>
  <script src="hariislam.js"></script>
  <script src="ayathadits.js"></script>
  <!-- <script src="online-license-client.js"></script> -->

  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <script src="license-system3.js"></script>



  <!-- Screen Manager -->
  <script src="screen-manager.js"></script>
  <style>
    /* Hilangkan scrollbar vertikal dan horizontal */
    html, body {
        overflow: hidden;
        width: 100%;
        height: 100%;
        background-color: #f8f9fa;
    }
    
    /* Header */
    .header {
      background: linear-gradient(135deg, #005a31 0%, #00816d 100%);
      color: #fff;
      padding: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      position: relative;
      z-index: 1000;
    }
    .header img {
      max-height: 50px;
      border-radius: 8px;
    }

    /* Media Container */
    .media-container {
        display: flex;
        height: calc(100vh - 180px);
        overflow: hidden;
        background: white;
    }

    /* Frame Kiri (30%) */
    .media-left {
        width: 30%;
        background: linear-gradient(180deg, #f8f9fa 0%, #e9ecef 100%);
        overflow: hidden;
    }

    /* Frame Kanan (70%) */
    .media-right {
        width: 70%;
        position: relative;
    }

    /* Carousel Kanan */
    #mainCarousel {
      height: 100%;
    }

    .carousel-item {
      height: 100%;
      position: relative;
    }

    .carousel-item img {
      object-fit: cover;
      width: 100%;
      height: 100%;
    }

    /* Carousel Kiri */
    #leftCarousel {
      height: 100%;
      background: #0c3321;
    }

    #leftCarousel .carousel-item {
      height: 100%;
      padding: 10px;
    }

    /* Tambahkan di bagian CSS */
    #leftCarousel .carousel-indicators {
        position: absolute;
        bottom: 10px;
        left: 0;
        right: 0;
        z-index: 2;
        display: flex;
        justify-content: center;
        padding: 0;
        margin: 0;
        list-style: none;
    }

    #leftCarousel .carousel-indicators button {
        width: 10px;
        height: 10px;
        margin: 0 5px;
        border-radius: 50%;
        background-color: rgba(255, 255, 255, 0.5);
        border: none;
        cursor: pointer;
        transition: background-color 0.3s ease;
    }

    /* Tambahkan di bagian CSS */
    #leftCarousel .carousel-item,
    #mainCarousel .carousel-item {
        pointer-events: none !important; /* Mencegah click events */
    }

    #leftCarousel .carousel-item .left-card,
    #mainCarousel .carousel-item img {
        pointer-events: none !important; /* Pastikan child elements juga tidak bisa diklik */
    }

    /* Biarkan hanya carousel indicators yang bisa diklik */
    #leftCarousel .carousel-indicators button,
    #mainCarousel .carousel-indicators button {
        pointer-events: auto !important;
        cursor: pointer !important;
    }

    .left-card {
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      height: 100%;
      display: flex;
      flex-direction: column;
    }

    .left-card .card-body {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
    }

    /* Jadwal Adzan */
    .adzan-table {
      position: fixed;
      bottom: 30px;
      left: 0;
      width: 100%;
      margin: 0;
      padding: 0;
      z-index: 1000;
      background: white;
      box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
    }

    .adzan-table th {
      background: #005a31;
      color: white;
      font-weight: 600;
      padding: 5px 5px;
      font-size: 20px;
      border: none !important;
    }

    .adzan-table td {
      padding: 15px 5px;
      font-size: 40px;
      font-weight: bold;
      color: #333;
      transition: all 0.3s ease;
      cursor: pointer;
      position: relative;
      border: none !important;
    }

    .adzan-table .table > :not(caption) > * > * {
      border: none !important;
    }

    .adzan-table .table-bordered > :not(caption) > * {
      border: none !important;
    }

    .adzan-table td.active {
      background: #005a31 !important;
      color: white !important;
    }

    /* Running text */
    .marquee {
      position: fixed;
      bottom: -5px;
      left: 0;
      width: 100%;
      background: linear-gradient(90deg, #005a31 0%, #005a31 100%);
      color: white;
      font-weight: bold;
      padding: 1px 0;
      z-index: 1001;
      margin: 0;
      font-size: 18px;
    }

    marquee {
      padding: 0 20px;
    }

    /* Popup dan Overlay */
    .popup-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 9999;
      display: none;
      align-items: center;
      justify-content: center;
    }

    .popup-content {
      background: rgba(255, 255, 255, 0.7);
      border-radius: 16px;
      padding: 30px;
      max-width: 500px;
      width: 90%;
      box-shadow: 0 20px 40px rgba(0,0,0,0.3);
      animation: popupIn 0.3s ease;
    }

    @keyframes popupIn {
      from { opacity: 0; transform: scale(0.9); }
      to { opacity: 1; transform: scale(1); }
    }

    /* Black Overlay */
    #blackOverlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: black;
      display: none;
      z-index: 9999;
    }

    /* Toast Notification */
    .toast-notification {
      position: fixed;
      top: 30%;
      right: 20px;
      z-index: 99999;
      min-width: 300px;
      animation: slideInRight 0.3s ease;
    }

    @keyframes slideInRight {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }

    .col-12.col-md-4.d-flex.justify-content-end.align-items-center {
      position: relative;
      z-index: 1000;
      padding-right: 40px; /* Beri ruang untuk tombol pengaturan */
    }

    /* Tombol Pengaturan */
    /* Tombol Pengaturan - Versi Sederhana untuk STB */
    #settingsBtn {
      position: fixed;
      top: 22px;
      right: 10px;
      z-index: 1002;
      width: 35px;
      height: 35px;
      border-radius: 8px;
      color: white;
      display: block; /* Ganti dari flex */
      text-align: center;
      line-height: 35px; /* Center vertikal */
      cursor: pointer;
      padding: 0;
      font-size: 20px; /* Tampilkan icon */
    }

    /* Hilangkan semua pseudo elements dan CSS transform */
    #settingsBtn i {
      display: inline-block;
      transition: none; /* Nonaktifkan animasi untuk STB */
    }


    /* Untuk STB, lebih baik gunakan icon tetap tanpa animasi */
    @media (max-width: 768px) {
      #settingsBtn {
        width: 30px;
        height: 30px;
        line-height: 41px;
        font-size: 22px;
      }
    }

    

    /* Progress Bar untuk Lisensi */
    .progress {
      height: 10px;
      border-radius: 5px;
      overflow: hidden;
    }

    /* Custom Scrollbar */
    ::-webkit-scrollbar {
      width: 8px;
    }

    ::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb {
      background: #005a31;
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #00816d;
    }

    /* Tombol Khusus */
    .btn-custom {
      background: linear-gradient(135deg, #005a31 0%, #00816d 100%);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .btn-custom:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,90,49,0.3);
    }

    /* Card Image Preview */
    .image-preview {
      border: 2px dashed #ddd;
      border-radius: 8px;
      padding: 10px;
      margin-bottom: 10px;
      transition: all 0.3s ease;
    }

    .image-preview:hover {
      border-color: #005a31;
      background: #f8f9fa;
    }

    /* License Warning */
    .license-warning {
      animation: pulse 2s infinite;
    }

    /* Untuk tampilan mobile/STB */
    @media (max-width: 768px) {
      .col-12.col-md-4.d-flex.justify-content-end.align-items-center {
        padding-right: 60px;
      }
      
      #clock {
        font-size: 35px;
        min-width: 120px;
        margin-right: 50px;
      }
      
      #settingsBtn {
        width: 45px;
        height: 45px;
        font-size: 22px;
      }
    }

    /* Pastikan header memiliki z-index yang tepat */
    .container-fluid.header {
      position: relative;
      z-index: 1001;
    }

    /* Sembunyikan tombol prev/next di semua carousel */
    .carousel-control-prev,
    .carousel-control-next {
        display: none !important;
    }

    /* Indicator untuk slide kanan */
    #mainCarousel .carousel-indicators {
        bottom: 10px;
    }

    /* Indicator untuk slide kiri */
    #leftCarousel .carousel-indicators {
        bottom: 10px;
    }

    /* Transisi untuk slide kiri (slide down) */
    #leftCarousel .carousel-inner .carousel-item {
        transition: transform 0.8s ease-in-out !important;
    }

    /* Transisi untuk slide kanan (opacity) */
    #mainCarousel .carousel-inner .carousel-item {
        transition: opacity 0.8s ease-in-out !important;
    }

    /* Hilangkan transition default Bootstrap */
    .carousel-item {
        transition: none !important;
    }

    /* Pastikan carousel items proper */
    #leftCarousel .carousel-item-next:not(.carousel-item-start),
    #leftCarousel .active.carousel-item-end {
        transform: translateY(100%) !important;
    }

    #leftCarousel .carousel-item-prev:not(.carousel-item-end),
    #leftCarousel .active.carousel-item-start {
        transform: translateY(-100%) !important;
    }

    #mainCarousel .carousel-item-next:not(.carousel-item-start),
    #mainCarousel .active.carousel-item-end {
        opacity: 0 !important;
    }

    #mainCarousel .carousel-item-prev:not(.carousel-item-end),
    #mainCarousel .active.carousel-item-start {
        opacity: 0 !important;
    }

    /* Style tombol plus/minus yang lebih baik */
    .btn-outline-primary, .btn-outline-success {
        width: 50px !important;
        height: 50px !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        font-size: 1.5rem !important;
        border-width: 2px !important;
    }

    /* Untuk tampilan STB */
    @media (max-width: 768px) {
        .btn-outline-primary, .btn-outline-success {
            width: 45px !important;
            height: 45px !important;
            font-size: 1.3rem !important;
        }
    }

    /* Modal pengaturan waktu sholat */
    #prayerSettingsModal .modal-body {
      padding: 1.5rem;
    }

    #prayerSettingsModal .btn-lg {
      padding: 15px;
      font-size: 16px;
      margin-bottom: 10px;
    }

    #prayerSettingsModal .btn-group {
      margin-top: 10px;
    }

    #prayerSettingsModal .btn-group .btn {
      flex: 1;
      padding: 10px 0;
    }

    /* Tombol offset */
    .btn-outline-primary {
      border-color: #005a31;
      color: #005a31;
    }

    .btn-outline-primary:hover {
      background-color: #005a31;
      border-color: #005a31;
      color: white;
    }

    /* Popup Adzan dan Iqamah di sebelah kanan */
    .popup-overlay#popupAdzanOverlay,
    .popup-overlay#iqamahPopupOverlay {
      position: fixed;
      top: 42% !important;
      right: 20px !important;
      left: auto !important;
      width: auto !important;
      height: auto !important;
      max-width: 400px !important;
      transform: translateY(-50%) !important;
      display: none;
      align-items: center !important;
      justify-content: center !important;
      z-index: 9999 !important;
      border-radius: 15px;
      padding: 20px;
      animation: popupIn 0.3s ease !important;
    }

    /* Popup Peringatan di tengah */
    .popup-overlay#warningPopupOverlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.9);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 10000;
      animation: fadeIn 0.3s ease;
    }

    /* Popup Imsak dan Syuruq di tengah */
    .popup-overlay#popupImsakOverlay,
    .popup-overlay#popupSyuruqOverlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.9);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 10000;
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    /* Tombol close di overlay hitam */
    #closeBlackOverlay {
      position: fixed;
      top: 20px;
      left: 20px;
      z-index: 10006;
      font-size: 2rem;
      color: white;
      background: rgba(255, 255, 255, 0.2);
      border: none;
      border-radius: 50%;
      width: 60px;
      height: 60px;
      display: none;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    }

    #closeBlackOverlay:hover {
      background: rgba(255, 255, 255, 0.3);
    }

    /* ================= JAM TETAP DI ATAS BLACK OVERLAY ================= */
    #clock {
      position: fixed;              /* lepas dari header */
      top: 10px;                    /* posisi asli jam Anda */
      right: 50px;
      z-index: 10005;
      pointer-events: none;         /* tidak ganggu klik */
    }

    /* Untuk STB / mobile */
    @media (max-width: 768px) {
      #closeBlackOverlay {
        width: 30px;
        height: 30px;
        font-size: 20px;
      }
    }

    /* Tombol Screen OFF */
    #screenOffBtn {
      position: fixed;
      top: 22px;
      left: 10px;
      z-index: 1002;
      width: 35px;
      height: 35px;
      border-radius: 8px;
      color: white;
      text-align: center;
      line-height: 35px;
      cursor: pointer;
      font-size: 20px;
    }

    #screenOffBtn i {
      pointer-events: none;
    }

    /* Samakan ukuran dengan tombol gir */
    @media (max-width: 768px) {
      #screenOffBtn {
        width: 45px;
        height: 45px;
        line-height: 45px;
        font-size: 22px;
      }
    }

    #screenblack {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: black;
      display: none;
      z-index: 20000;
    }


  </style>
</head>
<body>

<div id="screenblack"></div>


<!-- Black Overlay -->
<div id="blackOverlay">
  <button id="closeBlackOverlay" onclick="closeBlackOverlay()">‚úï</button>
</div>

<!-- Tombol Pengaturan -->
<div id="settingsBtn" data-bs-toggle="offcanvas" data-bs-target="#mainOffcanvasMenu">
  <i class="bi bi-gear-fill"></i>
</div>

<!-- Header -->
<div class="container-fluid header p-2">
  <div class="row align-items-center">
    <!-- Kiri: Tanggal dan Kalender Hijriyah -->
    <div class="col-12 col-md-4 text-start mb-2 mb-md-0">
      <div id="currentDate" style="font-size: 22px; font-weight: 600; margin-left: 40px;"></div>
      <!-- Tombol Screen OFF -->
      <div id="screenOffBtn">
        <i class="bi bi-power"></i>
      </div>
      <div id="hijriDate" style="font-size: 18px; color: #c6f6d5; margin-left: 40px;"></div>
    </div>
    <!-- Tengah: Logo & Nama Masjid serta Alamat -->
    <div class="col-12 col-md-4 d-flex align-items-center justify-content-center mb-2 mb-md-0">
      <img id="masjidLogo" src="logo.png" alt="Logo Masjid" class="img-fluid me-3" style="border-radius: 10px; box-shadow: 0 4px 8px rgba(0,0,0,0.2);">
      <div>
        <h2 id="masjidName" class="mb-1" style="font-weight: 800; color: white;">Al-Muthmainnah</h2>
        <p id="masjidAddress" class="mb-0" style="font-size: 14px; color: #c6f6d5;">Desa Toluwaya, Bulango Timur</p>
      </div>
    </div>
    <!-- Kanan: Jam -->
    <div class="col-12 col-md-4 d-flex justify-content-end align-items-center">
      <div id="clock" class="text-white" style="font-size: 40px; font-weight: 700; min-width: 140px; text-align: center;">
        --:--:--
      </div>
    </div>
  </div>
</div>

<!-- Media Container -->
<div class="media-container">
  <!-- Frame Kiri (30%) -->
  <div class="media-left">
    <div id="leftCarousel" class="carousel slide h-100" data-bs-ride="carousel" data-bs-interval="10000">
      <div class="carousel-inner h-100" id="leftCarouselInner">
        <!-- Slide akan diisi JavaScript -->
      </div>
      <button class="carousel-control-prev" type="button" data-bs-target="#leftCarousel" data-bs-slide="prev">
        <span class="carousel-control-prev-icon"></span>
      </button>
      <button class="carousel-control-next" type="button" data-bs-target="#leftCarousel" data-bs-slide="next">
        <span class="carousel-control-next-icon"></span>
      </button>
    </div>
  </div>

  <!-- Frame Kanan (70%) -->
  <div class="media-right">
    <div id="mainCarousel" class="carousel slide h-100" data-bs-ride="carousel" data-bs-interval="8000">
      <div class="carousel-indicators">
        <button type="button" data-bs-target="#mainCarousel" data-bs-slide-to="0" class="active"></button>
        <button type="button" data-bs-target="#mainCarousel" data-bs-slide-to="1"></button>
        <button type="button" data-bs-target="#mainCarousel" data-bs-slide-to="2"></button>
        <button type="button" data-bs-target="#mainCarousel" data-bs-slide-to="3"></button>
        <button type="button" data-bs-target="#mainCarousel" data-bs-slide-to="4"></button>
      </div>
      <div class="carousel-inner h-100" id="mainCarouselInner">
        <!-- Gambar akan diisi JavaScript -->
      </div>
      <button class="carousel-control-prev" type="button" data-bs-target="#mainCarousel" data-bs-slide="prev">
        <span class="carousel-control-prev-icon"></span>
      </button>
      <button class="carousel-control-next" type="button" data-bs-target="#mainCarousel" data-bs-slide="next">
        <span class="carousel-control-next-icon"></span>
      </button>
    </div>
  </div>
</div>

<!-- Jadwal Adzan -->
<div class="container-fluid p-0 adzan-table">
  <div class="table-responsive">
    <table class="table table-bordered text-center m-0">
      <thead>
        <tr id="jadwalHeader">
            <th id="thImsak">Imsak</th> <!-- TAMBAH INI -->
            <th id="thShubuh">Shubuh</th>
            <th id="thSyuruq">Syuruq</th>
            <th id="thDzuhur">Dzuhur</th>
            <th id="thAshar">Ashar</th>
            <th id="thMaghrib">Maghrib</th> <!-- TAMBAH INI -->
            <th id="thIsya">Isya</th> <!-- TAMBAH INI -->
        </tr>
      </thead>
      <tbody>
        <tr id="jadwalTimes">
          <td id="timeImsak">--:--</td>
          <td id="timeShubuh">--:--</td>
          <td id="timeSyuruq">--:--</td>
          <td id="timeDzuhur">--:--</td>
          <td id="timeAshar">--:--</td>
          <td id="timeMaghrib">--:--</td>
          <td id="timeIsya">--:--</td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

<!-- Running Text -->
<div class="marquee">
  <marquee behavior="scroll" direction="left" id="runningTextDisplay">
    Mohon untuk Menonaktifkan atau Mode Silent HP Anda jika Iqamah Telah Tiba, Agar tidak mengganggu kekhusyukan Shalat || Allah Subhanahu Wa Ta'ala berfirman : "Sesungguhnya shalat itu mencegah dari (perbuatan) keji dan mungkar" (Q.S. Al-Ankabut:45).
  </marquee>
</div>

<!-- ==================== MODAL & POPUP ==================== -->

<!-- Popup Adzan -->
<div class="popup-overlay" id="popupAdzanOverlay">
  <div class="popup-content text-center">
    <h2 id="popupAdzanText" class="mb-4" style="color: #005a31;"></h2>
    <div id="popupCountdown" class="display-1 mb-4" style="font-weight: 800; color: #005a31;"></div>
    <div class="progress mb-3" style="height: 10px;">
      <div id="popupProgress" class="progress-bar bg-success" style="width: 100%"></div>
    </div>
  </div>
</div>

<!-- Popup Iqamah -->
<div class="popup-overlay" id="iqamahPopupOverlay">
  <div class="popup-content text-center">
    <h2 id="iqamahText" class="mb-4" style="color: #005a31;"></h2>
    <div id="iqamahTimer" class="display-1 mb-4" style="font-weight: 800; color: #005a31;"></div>
    <div class="progress mb-3" style="height: 10px;">
      <div id="iqamahProgress" class="progress-bar bg-warning" style="width: 100%"></div>
    </div>
  </div>
</div>

<!-- Popup Peringatan 15 detik sebelum iqamah -->
<div class="popup-overlay" id="warningPopupOverlay">
  <div class="popup-content text-center">
    <h2 id="warningText" class="mb-4" style="color: #dc3545;"></h2>
    <div id="warningTimer" class="display-1 mb-4" style="font-weight: 800; color: #dc3545;">15</div>
    <div class="progress mb-3" style="height: 10px;">
      <div id="warningProgress" class="progress-bar bg-danger" style="width: 100%"></div>
    </div>
    <p class="lead mt-4" style="font-size: 1.5rem; font-weight: bold;">Mohon Nonaktifkan HP Anda segera!</p>
  </div>
</div>

<!-- Popup Imsak -->
<div class="popup-overlay" id="popupImsakOverlay">
  <div class="popup-content text-center">
    <h2 id="popupImsakText" class="mb-4" style="color: #005a31;">Waktu Imsak telah Tiba</h2>
    <div id="imsakBeepCounter" class="display-1 mb-4" style="font-weight: 800; color: #005a31;">15</div>
    <div class="progress mb-3" style="height: 10px;">
      <div id="imsakProgress" class="progress-bar bg-info" style="width: 100%"></div>
    </div>
    <p class="lead mt-4" style="font-size: 1.5rem; font-weight: bold;">Segera hentikan makan dan minum!</p>
  </div>
</div>

<!-- Popup Syuruq -->
<div class="popup-overlay" id="popupSyuruqOverlay">
  <div class="popup-content text-center">
    <h2 id="popupSyuruqText" class="mb-4" style="color: #ff9800;">Waktu Syuruq telah Tiba</h2>
    <div id="syuruqBeepCounter" class="display-1 mb-4" style="font-weight: 800; color: #ff9800;">15</div>
    <div class="progress mb-3" style="height: 10px;">
      <div id="syuruqProgress" class="progress-bar bg-warning" style="width: 100%"></div>
    </div>
    <p class="lead mt-4" style="font-size: 1.5rem; font-weight: bold;">Matahari telah terbit</p>
  </div>
</div>

<!-- Modal Lisensi -->
<div class="modal fade" id="licenseModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h4 class="modal-title"><i class="bi bi-exclamation-triangle-fill me-2"></i>Masa Aktif Aplikasi Habis</h4>
      </div>
      <div class="modal-body text-center py-4">
        <div class="display-1 mb-3">‚è∞</div>
        <h3 class="mb-3">Masa Aktif Aplikasi telah Habis</h3>
        <p class="lead mb-4">Untuk melanjutkan penggunaan, silahkan hubungi Developer:</p>
        <div class="alert alert-info">
          <h4><i class="bi bi-telephone-fill me-2"></i>089609745090</h4>
          <p class="mb-0">Email: developer@adzanapp.com</p>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal Pengaturan Waktu -->
<div class="modal fade" id="prayerSettingsModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title" id="prayerNameLabel">Pengaturan Waktu Sholat</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="d-grid gap-2 mb-4">
          <button class="btn btn-success btn-lg" onclick="showCountdownForm('adzan')">
            <i class="bi bi-clock me-2"></i>Countdown Adzan
          </button>
          <button class="btn btn-warning btn-lg" onclick="showCountdownForm('iqamah')">
            <i class="bi bi-hourglass-split me-2"></i>Countdown Iqamah
          </button>
          <button class="btn btn-dark btn-lg" onclick="showCountdownForm('overlay')">
            <i class="bi bi-moon-stars me-2"></i>Durasi Overlay
          </button>
        </div>
        
        <div class="card mb-3">
          <div class="card-header bg-info text-white">
            <i class="bi bi-sliders me-2"></i>Offset Waktu Manual
          </div>
          <div class="card-body">
            <label class="form-label">Sesuaikan Waktu (menit)</label>
            <div class="btn-group w-100 mb-3">
              <button class="btn btn-outline-primary" onclick="adjustOffset(-5)">-5</button>
              <button class="btn btn-outline-primary" onclick="adjustOffset(-1)">-1</button>
              <button class="btn btn-outline-primary" onclick="adjustOffset(0)">Reset</button>
              <button class="btn btn-outline-primary" onclick="adjustOffset(+1)">+1</button>
              <button class="btn btn-outline-primary" onclick="adjustOffset(+5)">+5</button>
            </div>
            <div class="text-center">
              <span id="currentOffset" class="badge bg-primary">Offset: 0 menit</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal Form Countdown -->
<div class="modal fade" id="countdownFormModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header" id="countdownModalHeader">
        <h5 class="modal-title" id="countdownTitle">Pengaturan</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="countdownFormBody">
        <!-- Form akan diisi JavaScript -->
      </div>
    </div>
  </div>
</div>

<!-- ==================== OFFCANVAS MENU ==================== -->

<!-- Main Offcanvas Menu -->
<div class="offcanvas offcanvas-end" tabindex="-1" id="mainOffcanvasMenu" aria-labelledby="mainOffcanvasMenuLabel">
  <div class="offcanvas-header bg-primary text-white">
    <h4 class="offcanvas-title" id="mainOffcanvasMenuLabel"><i class="bi bi-gear-fill me-2"></i>Pengaturan</h4>
    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas"></button>
  </div>
  <div class="offcanvas-body">
    <div class="d-grid gap-2">
      <button class="btn btn-success btn-lg" data-bs-toggle="offcanvas" data-bs-target="#offcanvasDataMasjid">
        <i class="bi bi-building me-2"></i>Data Masjid
      </button>
      <button class="btn btn-success btn-lg" data-bs-toggle="offcanvas" data-bs-target="#offcanvasRunningText">
        <i class="bi bi-textarea-t me-2"></i>Running Text
      </button>
      <button class="btn btn-success btn-lg" data-bs-toggle="offcanvas" data-bs-target="#offcanvasPesanTeks">
        <i class="bi bi-chat-text me-2"></i>Pesan Teks (Slide 1)
      </button>
      <button class="btn btn-success btn-lg" data-bs-toggle="offcanvas" data-bs-target="#offcanvasUploadGambar">
        <i class="bi bi-images me-2"></i>Upload Gambar
      </button>
      <button class="btn btn-success btn-lg" onclick="showSliderSettingsForm()">
        <i class="bi bi-sliders me-2"></i>Durasi Slider
      </button>
      <button class="btn btn-success btn-lg" data-bs-toggle="offcanvas" data-bs-target="#offcanvasTutorial">
        <i class="bi bi-book me-2"></i>Tutorial
      </button>
      <button class="btn btn-success btn-lg" data-bs-toggle="offcanvas" data-bs-target="#offcanvasInfoAplikasi">
        <i class="bi bi-info-circle me-2"></i>Info Aplikasi
      </button>
    </div>
  </div>
</div>

<!-- Offcanvas Data Masjid -->
<div class="offcanvas offcanvas-end" tabindex="-1" id="offcanvasDataMasjid">
  <div class="offcanvas-header bg-primary text-white">
    <button type="button" class="btn btn-light me-3" data-bs-toggle="offcanvas" data-bs-target="#mainOffcanvasMenu">
      <i class="bi bi-arrow-left"></i>
    </button>
    <h5 class="offcanvas-title">üìç Data Masjid</h5>
  </div>
  <div class="offcanvas-body">
    <form id="masjidDataForm">
      <div class="mb-3">
        <label class="form-label">Logo Masjid</label>
        <input type="file" class="form-control" id="logoInput" accept="image/*">
        <small class="text-muted">Upload logo (PNG/JPG, maks 500KB)</small>
        <div id="logoPreview" class="mt-2 text-center">
          <img id="logoPreviewImg" src="logo.png" style="max-width: 200px; max-height: 200px;" class="img-thumbnail">
        </div>
      </div>
      <div class="mb-3">
        <label class="form-label">Nama Masjid</label>
        <input type="text" class="form-control" id="namaMasjidInput" required>
      </div>
      <div class="mb-3">
        <label class="form-label">Alamat Masjid</label>
        <textarea class="form-control" id="alamatMasjidInput" rows="3" required></textarea>
      </div>
      <button type="submit" class="btn btn-primary w-100 mb-2">
        <i class="bi bi-save me-2"></i>Simpan Data
      </button>
    </form>
    <button class="btn btn-danger w-100" id="resetMasjidData">
      <i class="bi bi-arrow-clockwise me-2"></i>Reset ke Default
    </button>
  </div>
</div>

<!-- Offcanvas Running Text -->
<div class="offcanvas offcanvas-end" tabindex="-1" id="offcanvasRunningText">
  <div class="offcanvas-header bg-primary text-white">
    <button type="button" class="btn btn-light me-3" data-bs-toggle="offcanvas" data-bs-target="#mainOffcanvasMenu">
      <i class="bi bi-arrow-left"></i>
    </button>
    <h5 class="offcanvas-title">üìú Running Text</h5>
  </div>
  <div class="offcanvas-body">
    <form id="runningTextForm">
      <div id="runningTextInputs">
        <div class="mb-3">
          <label class="form-label">Running Text 1</label>
          <input type="text" class="form-control" id="runningText1" required>
        </div>
      </div>
      <button type="button" class="btn btn-info w-100 mb-3" id="addRunningTextBtn">
        <i class="bi bi-plus-circle me-2"></i>Tambah Running Text
      </button>
      <button type="submit" class="btn btn-primary w-100">
        <i class="bi bi-save me-2"></i>Simpan Running Text
      </button>
    </form>
  </div>
</div>

<!-- Offcanvas Pesan Teks -->
<div class="offcanvas offcanvas-end" tabindex="-1" id="offcanvasPesanTeks">
  <div class="offcanvas-header bg-primary text-white">
    <button type="button" class="btn btn-light me-3" data-bs-toggle="offcanvas" data-bs-target="#mainOffcanvasMenu">
      <i class="bi bi-arrow-left"></i>
    </button>
    <h5 class="offcanvas-title">üí¨ Pesan Teks Slide 1</h5>
  </div>
  <div class="offcanvas-body">
    <form id="pesanTeksForm">
      <div class="mb-3">
        <label class="form-label">Pesan untuk Slide 1</label>
        <textarea class="form-control" id="pesanTeksInput" rows="6" maxlength="300"></textarea>
        <div class="form-text">
          <span id="charCount">0</span>/300 karakter
        </div>
      </div>
      <button type="submit" class="btn btn-primary w-100">
        <i class="bi bi-save me-2"></i>Simpan Pesan
      </button>
    </form>
    <div class="alert alert-info mt-3">
      <i class="bi bi-info-circle me-2"></i>
      Pesan ini akan ditampilkan di Slide 1 carousel kiri
    </div>
  </div>
</div>

<!-- Offcanvas Upload Gambar -->
<div class="offcanvas offcanvas-end" tabindex="-1" id="offcanvasUploadGambar">
  <div class="offcanvas-header bg-primary text-white">
    <button type="button" class="btn btn-light me-3" data-bs-toggle="offcanvas" data-bs-target="#mainOffcanvasMenu">
      <i class="bi bi-arrow-left"></i>
    </button>
    <h5 class="offcanvas-title">üñºÔ∏è Upload Gambar (Maks. 5)</h5>
  </div>
  <div class="offcanvas-body">
    <div class="mb-3">
      <label class="form-label">Pilih Gambar</label>
      <input type="file" class="form-control" id="imageUpload" accept="image/jpeg,image/png" multiple>
      <small class="text-muted">Pilih 1-5 gambar (JPG/PNG, maks 1MB per gambar)</small>
    </div>
    
    <div id="uploadProgress" class="progress mb-3" style="display: none;">
      <div class="progress-bar progress-bar-striped progress-bar-animated" style="width: 0%"></div>
    </div>
    
    <button class="btn btn-success w-100 mb-3" onclick="uploadImages()">
      <i class="bi bi-cloud-upload me-2"></i>Upload Gambar
    </button>
    
    <div id="uploadedImagesList">
      <h6>Gambar Terupload:</h6>
      <div id="imagesContainer" class="row">
        <!-- Gambar akan ditampilkan di sini -->
      </div>
    </div>
  </div>
</div>

<!-- Offcanvas Tutorial -->
<div class="offcanvas offcanvas-end" tabindex="-1" id="offcanvasTutorial">
  <div class="offcanvas-header bg-primary text-white">
    <button type="button" class="btn btn-light me-3" data-bs-toggle="offcanvas" data-bs-target="#mainOffcanvasMenu">
      <i class="bi bi-arrow-left"></i>
    </button>
    <h5 class="offcanvas-title">üìñ Tutorial Penggunaan</h5>
  </div>
  <div class="offcanvas-body">
    <div class="accordion" id="tutorialAccordion">
      <div class="accordion-item">
        <h2 class="accordion-header">
          <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#tutorial1">
            <i class="bi bi-clock me-2"></i>1. Pengaturan Waktu Sholat
          </button>
        </h2>
        <div id="tutorial1" class="accordion-collapse collapse show">
          <div class="accordion-body">
            <p>Klik pada waktu sholat di tabel untuk membuka pengaturan:</p>
            <ul>
              <li><strong>Countdown Adzan</strong>: Atur waktu countdown sebelum adzan</li>
              <li><strong>Countdown Iqamah</strong>: Atur waktu menunggu iqamah</li>
              <li><strong>Durasi Overlay</strong>: Atur berapa lama overlay hitam ditampilkan</li>
              <li><strong>Offset Waktu</strong>: Sesuaikan +/- menit dari waktu otomatis</li>
            </ul>
          </div>
        </div>
      </div>
      <div class="accordion-item">
        <h2 class="accordion-header">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#tutorial2">
            <i class="bi bi-images me-2"></i>2. Upload Gambar
          </button>
        </h2>
        <div id="tutorial2" class="accordion-collapse collapse">
          <div class="accordion-body">
            <p>Maksimal 5 gambar untuk carousel kanan:</p>
            <ol>
              <li>Buka menu <strong>Upload Gambar</strong></li>
              <li>Pilih gambar dari perangkat Anda</li>
              <li>Klik tombol Upload</li>
              <li>Gambar akan muncul di carousel kanan</li>
            </ol>
            <p class="text-muted">Catatan: Gambar disimpan di perangkat Anda (offline)</p>
          </div>
        </div>
      </div>
      <div class="accordion-item">
        <h2 class="accordion-header">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#tutorial3">
            <i class="bi bi-chat-text me-2"></i>3. Pesan Teks dan Running Text
          </button>
        </h2>
        <div id="tutorial3" class="accordion-collapse collapse">
          <div class="accordion-body">
            <p><strong>Pesan Teks:</strong> Untuk Slide 1 carousel kiri</p>
            <p><strong>Running Text:</strong> Untuk teks berjalan di bagian bawah layar</p>
            <p>Anda dapat menambahkan hingga 3 running text yang akan digabung</p>
          </div>
        </div>
      </div>
      <div class="accordion-item">
        <h2 class="accordion-header">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#tutorial4">
            <i class="bi bi-info-circle me-2"></i>4. Lisensi Aplikasi
          </button>
        </h2>
        <div id="tutorial4" class="accordion-collapse collapse">
          <div class="accordion-body">
            <p>Aplikasi memiliki masa aktif yang dapat diperpanjang:</p>
            <ul>
              <li>Trial: 30 hari</li>
              <li>3 Bulan: Rp 100.000</li>
              <li>1 Tahun: Rp 600.000</li>
              <li>3 Tahun: Rp 1.000.000</li>
              <li>Seumur Hidup: Rp 2.500.000</li>
            </ul>
            <p>Hubungi developer untuk perpanjangan</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Offcanvas Info Aplikasi -->
<div class="offcanvas offcanvas-end" tabindex="-1" id="offcanvasInfoAplikasi">
  <div class="offcanvas-header bg-primary text-white">
    <button type="button" class="btn btn-light me-3" data-bs-toggle="offcanvas" data-bs-target="#mainOffcanvasMenu">
      <i class="bi bi-arrow-left"></i>
    </button>
    <h5 class="offcanvas-title">‚ÑπÔ∏è Info Aplikasi</h5>
  </div>
  <div class="offcanvas-body">
    <div class="text-center mb-4">
      <div class="display-1 mb-2">üïå</div>
      <h3>Adzan Al-Muthmainnah</h3>
      <p class="text-muted">v2.0 - Khusus STB Indihome HG680-P</p>
    </div>
    
    <div class="card mb-3">
      <div class="card-header bg-info text-white">
        <h6 class="mb-0"><i class="bi bi-shield-check me-2"></i>Status Lisensi</h6>
      </div>
      <div class="card-body">
        <p><strong>Paket:</strong> <span id="licensePackage">Trial</span></p>
        <p><strong>Status:</strong> <span id="licenseStatusText" class="badge bg-success">Aktif</span></p>
        <p><strong>Berakhir:</strong> <span id="licenseExpiryDate">-</span></p>
        <p><strong>Sisa Hari:</strong> <span id="licenseDaysLeft">30</span> hari</p>
        <div class="progress mb-2">
          <div id="licenseProgressBar" class="progress-bar" style="width: 100%"></div>
        </div>
        <small class="text-muted" id="licenseProgressText">100% tersisa</small>
      </div>
    </div>
    
    <div class="card mb-3">
      <div class="card-header bg-primary text-white">
        <h6 class="mb-0"><i class="bi bi-person-circle me-2"></i>Kontak Developer</h6>
      </div>
      <div class="card-body">
        <p><i class="bi bi-telephone me-2"></i><strong>Telepon:</strong> 089609745090</p>
        <p><i class="bi bi-envelope me-2"></i><strong>Email:</strong> support@adzanapp.com</p>
        <p><i class="bi bi-globe me-2"></i><strong>Website:</strong> www.adzanapp.com</p>
      </div>
    </div>
  </div>
</div>

<!-- ==================== AUDIO ELEMENTS ==================== -->
<audio id="audioShalawat" src="shalawat.mp3" loop preload="none"></audio>
<audio id="audioAdzan" src="adzan.mp3" preload="none"></audio>
<audio id="audioBeep" src="beep.mp3" preload="none"></audio>
<audio id="audioRooster" src="rooster.mp3" preload="none"></audio>

<!-- ==================== SCRIPTS ==================== -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
// ==================== VARIABLES GLOBAL ====================
var adzanSchedule = {};
var currentPrayer = '';
var isSTB = false;

// Data sederhana untuk STB
var settings = {
    masjidName: 'Al-Muthmainnah',
    masjidAddress: 'Desa Toluwaya, Bulango Timur',
    runningText: 'Mohon untuk Menonaktifkan atau Mode Silent HP Anda jika Iqamah Telah Tiba, Agar tidak mengganggu kekhusyukan Shalat',
    customMessage: 'Selamat datang di Masjid Al-Muthmainnah\\n\\nMari bersama menjaga kebersihan dan ketertiban masjid untuk kenyamanan beribadah kita semua.',
    uploadedImages: [],
    license: {
        package: 'Trial',
        expiry: new Date(new Date().setDate(new Date().getDate() + 30))
    }
};

// ==================== TAMBAHKAN VARIABEL BARU INI ====================
var adzanCountdownDurations = {};
var iqamahCountdownDurations = {};
var overlayBlackDurations = {};
var prayerOffsets = {};
var originalPrayerTimes = {}

var warningState = {
  active: false,
  interval: null
};

var imsakState = {
  active: false,
  beepCount: 0,
  interval: null
};

var syuruqState = {
  active: false,
  beepCount: 0,
  interval: null
};

var blackOverlayInterval = null;

// ‚úÖ DEFAULT GAMBAR CAROUSEL KANAN
var defaultMainImages = [
  'default1.jpg',
  'default2.jpg',
  'default3.jpg',
  'default4.jpg',
  'default5.jpg'
];


// ==================== AKHIR TAMBAHAN ====================

// ==================== INISIALISASI APLIKASI ====================
window.onload = function() {
    console.log('Aplikasi Adzan Al-Muthmainnah v2.0 diinisialisasi');
    
    // Deteksi STB
    isSTB = navigator.userAgent.toLowerCase().includes('stb') || !('ontouchstart' in window);

    // Cek dan update tampilan Jumat
    updateJumatDisplay();
    
    // Load data dari localStorage
    loadSettings();

    // Load countdown settings
    loadCountdownSettings();
    loadPrayerOffsets();

    
    updateHijri();
    // Inisialisasi komponen
    initClock();
    initDate();
    initHijri();
    initPrayerTimes();
    initCarousels();
    initRunningText();

    // Inisialisasi license system
    if (typeof offlineLicense !== 'undefined') {
        offlineLicense.initialize();
    }

    applyPrayerOffsets();

    
    // Setup event listeners sederhana
    setupSimpleEvents();
    
    // Update Jumat display setiap menit (untuk handle pergantian hari)
    setInterval(updateJumatDisplay, 60000);
    
};


// ==================== FUNGSI TANGGAL & WAKTU ====================
function initClock() {
    updateClock();
    setInterval(updateClock, 1000);
}

function updateClock() {
    try {
        var now = new Date();
        var hours = now.getHours();
        var minutes = now.getMinutes();
        var seconds = now.getSeconds();
        
        document.getElementById('clock').textContent = 
            (hours < 10 ? '0' : '') + hours + ':' + 
            (minutes < 10 ? '0' : '') + minutes + ':' + 
            (seconds < 10 ? '0' : '') + seconds;
    } catch (e) {
        console.log('Error updateClock:', e);
    }
}

function initDate() {
    updateDate();
    setInterval(updateDate, 300000);
}

function updateDate() {
    try {
        var now = new Date();
        var days = ['Minggu', 'Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu'];
        var months = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 
                     'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];
        
        var dateStr = days[now.getDay()] + ', ' + now.getDate() + ' ' + 
                     months[now.getMonth()] + ' ' + now.getFullYear();
        
        document.getElementById('currentDate').textContent = dateStr;
    } catch (e) {
        console.log('Error updateDate:', e);
    }
}

function initHijri() {
    updateHijri();
    setInterval(updateHijri, 300000);
}

function updateHijri() {
    try {
        var now = new Date();
        var hijriObj = HijriCalendar.get(now);

        // üî¥ INI YANG WAJIB ADA
        window.hijriDateString = hijriObj.text;
        window.currentHijriDate = hijriObj;

        document.getElementById('hijriDate').textContent = hijriObj.text;


    } catch (e) {
        window.hijriDateString = "";
        document.getElementById('hijriDate').textContent = "-- -- ---- H";
    }
}




// ==================== JADWAL ADZAN ====================
function initPrayerTimes() {
    // Koordinat Bone Bolango (sesuai permintaan)
    var lat = 0.6106944;   // Latitude
    var lng = 123.0846244; // Longitude
    
    // Set metode perhitungan (contoh: Kemenag)
    prayTimes.setMethod('Kemenag');
    
    // Hitung waktu sholat untuk hari ini
    var now = new Date();
    var times = prayTimes.getTimes(
        now,
        [lat, lng],
        8, // WITA (UTC+8)
        0  // No DST
    );
    
    // Format waktu sesuai kebutuhan Anda
    adzanSchedule = {
        imsak: formatPrayTime(times.imsak),
        shubuh: formatPrayTime(times.fajr),
        syuruq: formatPrayTime(times.sunrise),
        dzuhur: formatPrayTime(times.dhuhr),
        ashar: formatPrayTime(times.asr),
        maghrib: formatPrayTime(times.maghrib),
        isya: formatPrayTime(times.isha)
    };
    
    // Simpan waktu asli
    for (var prayer in adzanSchedule) {
        originalPrayerTimes[prayer] = adzanSchedule[prayer];
    }
    
    // Update tampilan
    updatePrayerTimesUI();
    
    // Cek waktu sholat setiap detik
    setInterval(checkPrayerTimes, 5000);
    
    // Debug: tampilkan waktu yang dihitung
    console.log('Waktu Sholat (PrayTimes):', adzanSchedule);
}

function formatPrayTime(timeStr) {
    if (!timeStr || timeStr.includes('-----')) {
        return '--:--';
    }
    
    // Convert dari format "HH:MM" atau "HH:MM (24h)"
    var time = timeStr.split(' ')[0]; // Ambil bagian waktu saja
    var parts = time.split(':');
    
    if (parts.length === 2) {
        return parts[0].padStart(2, '0') + ':' + parts[1].padStart(2, '0');
    }
    
    return '--:--';
}

/*
function calculateOfflinePrayerTimes(lat, lng) {
    // Algoritma sederhana untuk STB
    var now = new Date();
    var dayOfYear = Math.floor((now - new Date(now.getFullYear(), 0, 0)) / 86400000);
    
    // Deklinasi matahari sederhana
    var declination = 23.45 * Math.sin((2 * Math.PI / 365) * (dayOfYear - 81));
    
    // Equation of time sederhana
    var B = (2 * Math.PI / 365) * (dayOfYear - 81);
    var EoT = 9.87 * Math.sin(2 * B) - 7.53 * Math.cos(B) - 1.5 * Math.sin(B);
    
    // Timezone WITA (UTC+8)
    var timezone = 8;
    
    // Perhitungan waktu
    var solarNoon = 12 + (4 * (lng - (timezone * 15)) - EoT) / 60;
    
    // Hour angle untuk sunrise/sunset
    var latRad = lat * Math.PI / 180;
    var decRad = declination * Math.PI / 180;
    var ha = Math.acos(-Math.tan(latRad) * Math.tan(decRad)) * 180 / Math.PI / 15;
    
    // Waktu-waktu sholat dengan offset lokal
    var times = {
        imsak: addMinutes(formatTime(solarNoon - ha - 1.2), -2),
        shubuh: addMinutes(formatTime(solarNoon - ha - 0.7), -2),
        syuruq: formatTime(solarNoon - ha + 0.2),
        dzuhur: addMinutes(formatTime(solarNoon + 0.1), +1),
        ashar: addMinutes(formatTime(solarNoon + ha * 0.8), +2),
        maghrib: formatTime(solarNoon + ha - 0.1),
        isya: addMinutes(formatTime(solarNoon + ha + 0.5), +3)
    };
    
    return times;
}
    */

function formatTime(decimalHours) {
    var hour = Math.floor(decimalHours);
    var minute = Math.round((decimalHours - hour) * 60);
    
    if (minute >= 60) {
        hour++;
        minute -= 60;
    }
    if (hour >= 24) hour -= 24;
    if (hour < 0) hour += 24;
    
    return (hour < 10 ? '0' : '') + hour + ':' + (minute < 10 ? '0' : '') + minute;
}

function addMinutes(timeStr, minutes) {
    if (!timeStr || timeStr === '--:--') return '--:--';
    
    var parts = timeStr.split(':');
    var hour = parseInt(parts[0]);
    var minute = parseInt(parts[1]) + minutes;
    
    while (minute >= 60) {
        hour++;
        minute -= 60;
    }
    while (minute < 0) {
        hour--;
        minute += 60;
    }
    
    if (hour >= 24) hour -= 24;
    if (hour < 0) hour += 24;
    
    return (hour < 10 ? '0' : '') + hour + ':' + (minute < 10 ? '0' : '') + minute;
}

function updatePrayerTimesUI() {
    var elements = {
        imsak: 'timeImsak',
        shubuh: 'timeShubuh',
        syuruq: 'timeSyuruq',
        dzuhur: 'timeDzuhur',
        ashar: 'timeAshar',
        maghrib: 'timeMaghrib',
        isya: 'timeIsya'
    };
    
    for (var prayer in elements) {
        var element = document.getElementById(elements[prayer]);
        if (element && adzanSchedule[prayer]) {
            element.textContent = adzanSchedule[prayer];
        }
    }
    
    // Highlight sholat berikutnya
    highlightNextPrayer();
}

function highlightNextPrayer() {
    const now = new Date();
    const currentMinutes = now.getHours() * 60 + now.getMinutes();
    
    const prayers = ['imsak', 'shubuh', 'syuruq', 'dzuhur', 'ashar', 'maghrib', 'isya'];
    
    // Reset semua highlight
    prayers.forEach(p => {
        const el = document.getElementById('time' + p.charAt(0).toUpperCase() + p.slice(1));
        if (el) el.classList.remove('active');
    });
    
    // Ambil waktu Isya terlebih dahulu (karena siklus setelah Isya adalah Imsak)
    const isyaStr = adzanSchedule.isya;
    if (isyaStr && isyaStr !== '--:--') {
        const [ih, im] = isyaStr.split(':').map(Number);
        const isyaMinutes = ih * 60 + im;
        
        // ‚úÖ SETELAH ISYA ‚Üí IMSAK (untuk siklus dini hari)
        if (currentMinutes >= isyaMinutes) {
            const imsakCell = document.getElementById('timeImsak');
            if (imsakCell) imsakCell.classList.add('active');
            return;
        }
    }
    
    // Untuk Imsak dan Syuruq, kita perlu handle khusus
    // Urutan: Imsak ‚Üí Shubuh ‚Üí Syuruq ‚Üí Dzuhur ‚Üí Ashar ‚Üí Maghrib ‚Üí Isya
    
    for (let i = 0; i < prayers.length; i++) {
        const p = prayers[i];
        const timeStr = adzanSchedule[p];
        
        if (!timeStr || timeStr === '--:--') continue;
        
        const [h, m] = timeStr.split(':').map(Number);
        const prayerMinutes = h * 60 + m;
        
        // Jika waktu sholat ini lebih besar dari waktu sekarang
        if (prayerMinutes > currentMinutes) {
            const el = document.getElementById('time' + p.charAt(0).toUpperCase() + p.slice(1));
            if (el) el.classList.add('active');
            return;
        }
    }
    
    // Jika semua waktu sudah lewat, highlight Imsak untuk hari berikutnya
    const imsakCell = document.getElementById('timeImsak');
    if (imsakCell) imsakCell.classList.add('active');
}

// Panggil fungsi ini setiap menit untuk update highlight
setInterval(highlightNextPrayer, 60000);



// ==================== VARIABEL COUNTDOWN ====================
var countdownState = {
  active: false,
  type: null, // 'adzan' atau 'iqamah'
  prayer: null,
  remaining: 0,
  interval: null
};

var warningState = {
  active: false,
  interval: null
};

// ==================== FUNGSI COUNTDOWN ADZAN ====================
function showPopupAdzan(prayer) {
    // ================= KHUSUS JUMAT =================
    if (isJumat() && prayer === 'dzuhur') {
        countdownState.active = true;
        countdownState.type = 'adzan';
        countdownState.prayer = prayer;
        const durationMinutes = adzanCountdownDurations[prayer] || 15;
        countdownState.remaining = durationMinutes * 60;
        document.getElementById('popupAdzanText').innerHTML = `Waktu Adzan Jumat<br>`;
        document.getElementById('popupAdzanOverlay').style.display = 'block';
        
        // üîá PASTIKAN SHALAWAT MATI
        const shalawat = document.getElementById('audioShalawat');
        if (shalawat) {
            shalawat.pause();
            shalawat.currentTime = 0;
        }
        
        startAdzanCountdown();
        return;
    }
    
    // Kode asli untuk hari lain
    if (countdownState.active) return;
    
    const prayerNames = {
        shubuh: 'Shubuh',
        dzuhur: 'Dzuhur',
        ashar: 'Ashar',
        maghrib: 'Maghrib',
        isya: 'Isya'
    };
    
    if (!prayerNames[prayer]) return;
    
    // Set state
    countdownState.active = true;
    countdownState.type = 'adzan';
    countdownState.prayer = prayer;
    
    // Durasi countdown adzan (dalam detik)
    const durationMinutes = adzanCountdownDurations[prayer] || 10;
    countdownState.remaining = durationMinutes * 60;
    
    // Update popup text
    document.getElementById('popupAdzanText').textContent = `Waktu Adzan ${prayerNames[prayer]}`;
    
    // Tampilkan popup di sebelah kanan
    const popup = document.getElementById('popupAdzanOverlay');
    popup.style.display = 'block';
    popup.style.right = '20px';
    popup.style.left = 'auto';
    popup.style.transform = 'translateY(-50%)';
    popup.style.top = '50%';
    
    // Mainkan audio shalawat (loop)
    const audioShalawat = document.getElementById('audioShalawat');
    if (audioShalawat) {
        audioShalawat.currentTime = 0;
        audioShalawat.loop = true;
        audioShalawat.play().catch(e => console.log('Error playing shalawat:', e));
    }
    
    // Mulai countdown
    startAdzanCountdown();
}


function startAdzanCountdown() {
  if (countdownState.interval) {
    clearInterval(countdownState.interval);
  }
  
  const countdownElement = document.getElementById('popupCountdown');
  const progressElement = document.getElementById('popupProgress');
  const totalDuration = countdownState.remaining;
  
  countdownState.interval = setInterval(() => {
    const minutes = Math.floor(countdownState.remaining / 60);
    const seconds = countdownState.remaining % 60;
    
    countdownElement.textContent = 
      `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    
    const progress = (countdownState.remaining / totalDuration) * 100;
    progressElement.style.width = `${progress}%`;
    
    if (countdownState.remaining <= 0) {
      clearInterval(countdownState.interval);
      countdownState.interval = null;
      
      // Countdown adzan selesai
      endAdzanCountdown();
    }
    
    countdownState.remaining--;
  }, 1000);
}

function endAdzanCountdown() {
    // HENTIKAN AUDIO SHALAWAT
    const audioShalawat = document.getElementById('audioShalawat');
    if (audioShalawat) {
        audioShalawat.pause();
        audioShalawat.currentTime = 0;
    }
    
    // Tutup popup
    document.getElementById('popupAdzanOverlay').style.display = 'none';
    
    // ================= KHUSUS JUMAT =================
    if (isJumat() && countdownState.prayer === 'dzuhur') {
        // üîá MATIKAN SEMUA AUDIO (TERMASUK ADZAN)
        stopAllAudio();
        // ‚¨õ LANGSUNG AKTIFKAN OVERLAY JUMAT
        showJumatOverlay();
        // üî¥ CLEANUP MEMORY
        countdownState.active = false;
        countdownState.type = null;
        countdownState.prayer = null;
        countdownState.remaining = 0;
        // Clear DOM references
        document.getElementById('popupCountdown').textContent = '';
        document.getElementById('popupProgress').style.width = '0%';
        return; // ‚õî STOP, JANGAN KE IQAMAH
    }
    
    // ================= HARI BIASA =================
    const audioAdzan = document.getElementById('audioAdzan');
    if (audioAdzan) {
        audioAdzan.currentTime = 0;
        audioAdzan.play();
    }
    
    setTimeout(() => {
        showPopupIqamah(countdownState.prayer);
    }, 1000);
}


// ==================== FUNGSI KHUSUS UNTUK HARI JUMAT ====================
// Fungsi untuk mengecek apakah hari ini Jumat
function isJumat() {
    var now = new Date();
    return now.getDay() === 5; // 0 = Minggu, 5 = Jumat
}

// Fungsi untuk mengupdate teks Dzuhur menjadi Jumat
// Fungsi untuk mengupdate teks Dzuhur menjadi Jumat
function updateJumatDisplay() {
    if (isJumat()) {
        // Ganti teks "Dzuhur" menjadi "Jumat" di header
        var thDzuhur = document.getElementById('thDzuhur');
        if (thDzuhur) {
            thDzuhur.textContent = 'Jumat';
        }
        
        // HAPUS KODE BADGE di samping kanan - Hanya ganti highlight warna
        var timeDzuhurCell = document.getElementById('timeDzuhur');
        if (timeDzuhurCell) {
            // Hapus badge lama jika ada
            var existingBadge = timeDzuhurCell.querySelector('.jumat-badge');
            if (existingBadge) {
                existingBadge.remove();
            }
        }
    } else {
        // Kembalikan teks "Dzuhur" jika bukan Jumat
        var thDzuhur = document.getElementById('thDzuhur');
        if (thDzuhur) {
            thDzuhur.textContent = 'Dzuhur';
        }
    }
}

// Fungsi khusus untuk overlay Jumat
function showJumatOverlay() {
    
    stopAllAudio();
    
    document.getElementById('blackOverlay').style.display = 'block';
    document.getElementById('closeBlackOverlay').style.display = 'block';
    
    // Sembunyikan elemen yang perlu disembunyikan
    ['.media-container', '.adzan-table', '.marquee'].forEach(sel => {
        const el = document.querySelector(sel);
        if (el) {
            el.style.visibility = 'hidden';
            el.style.opacity = '0';
        }
    });
    
    // Tetap tampilkan header dan jam
    document.querySelector('.header').style.visibility = 'visible';
    document.querySelector('.header').style.opacity = '1';
    
    // Jam tetap di atas
    document.getElementById('clock').style.visibility = 'visible';
    document.getElementById('clock').style.opacity = '1';
    
    // Durasi overlay Jumat
    const durasiJumat = overlayBlackDurations['dzuhur'] || 90; // Default 90 menit untuk Jumat
    setTimeout(closeBlackOverlay, durasiJumat * 60 * 1000);
    
}

// Tambahkan CSS untuk badge Jumat
var jumatStyle = document.createElement('style');
jumatStyle.textContent = `
    .jumat-badge {
        display: inline-block;
        margin-left: 5px;
    }
    
    /* Highlight khusus untuk waktu Jumat */
    #timeDzuhur.active {
        background: #005a31 !important;
        color: white !important;
    }

    /* Tambahan untuk STB */
    @media (max-width: 768px) {
        .jumat-badge .badge {
            font-size: 12px !important;
            padding: 1px 5px !important;
        }
        
        #thDzuhur {
            font-size: 18px !important;
        }
    }
`;
document.head.appendChild(jumatStyle);



// ==================== FUNGSI COUNTDOWN IQAMAH ====================
function showPopupIqamah(prayer) {
  
  const prayerNames = {
    shubuh: 'Shubuh',
    dzuhur: 'Dzuhur',
    ashar: 'Ashar',
    maghrib: 'Maghrib',
    isya: 'Isya'
  };
  
  if (!prayerNames[prayer]) return;
  
  // Update state
  countdownState.type = 'iqamah';
  countdownState.prayer = prayer;
  
  // Durasi countdown iqamah (dalam detik)
  const durationMinutes = iqamahCountdownDurations[prayer] || 25;
  countdownState.remaining = durationMinutes * 60;
  
  // Update popup text
  document.getElementById('iqamahText').textContent = 
    `Waktu Iqamah ${prayerNames[prayer]}`;
  
  // Tampilkan popup di sebelah kanan
  const popup = document.getElementById('iqamahPopupOverlay');
  popup.style.display = 'block';
  popup.style.right = '20px';
  popup.style.left = 'auto';
  popup.style.transform = 'translateY(-50%)';
  popup.style.top = '50%';
  
  // Mulai countdown iqamah
  startIqamahCountdown();
}

function startIqamahCountdown() {
  if (countdownState.interval) {
    clearInterval(countdownState.interval);
  }
  
  const countdownElement = document.getElementById('iqamahTimer');
  const progressElement = document.getElementById('iqamahProgress');
  const totalDuration = countdownState.remaining;
  
  countdownState.interval = setInterval(() => {
    const minutes = Math.floor(countdownState.remaining / 60);
    const seconds = countdownState.remaining % 60;
    
    countdownElement.textContent = 
      `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    
    const progress = (countdownState.remaining / totalDuration) * 100;
    progressElement.style.width = `${progress}%`;
    
    // Cek jika 15 detik tersisa
    if (countdownState.remaining === 15) {
      showWarningPopup();
    }
    
    if (countdownState.remaining <= 0) {
      clearInterval(countdownState.interval);
      countdownState.interval = null;
      countdownState.active = false;
      
      // Countdown iqamah selesai
      endIqamahCountdown();
    }
    
    countdownState.remaining--;
  }, 1000);
}

function showWarningPopup() {
  
  // Tutup popup iqamah
  document.getElementById('iqamahPopupOverlay').style.display = 'none';
  
  // Tampilkan popup peringatan di tengah
  const popup = document.getElementById('warningPopupOverlay');
  popup.style.display = 'flex';
  popup.style.justifyContent = 'center';
  popup.style.alignItems = 'center';
  
  // Update text
  const prayerNames = {
    shubuh: 'Shubuh',
    dzuhur: 'Dzuhur',
    ashar: 'Ashar',
    maghrib: 'Maghrib',
    isya: 'Isya'
  };
  
  const prayerName = prayerNames[countdownState.prayer] || 'Shalat';
  document.getElementById('warningText').innerHTML = 
    `Shalat ${prayerName} akan dimulai`;
  
  // Mainkan audio beep (loop)
  const audioBeep = document.getElementById('audioBeep');
  if (audioBeep) {
    audioBeep.currentTime = 0;
    audioBeep.loop = true;
    audioBeep.play().catch(e => console.log('Error playing beep:', e));
  }
  
  // Mulai countdown peringatan (15 detik)
  let warningTime = 15;
  const warningElement = document.getElementById('warningTimer');
  const warningProgress = document.getElementById('warningProgress');
  
  if (warningState.interval) {
    clearInterval(warningState.interval);
  }
  
  warningState.active = true;
  warningState.interval = setInterval(() => {
    warningElement.textContent = 
      `${warningTime.toString().padStart(2, '0')}`;
    
    const progress = (warningTime / 15) * 100;
    warningProgress.style.width = `${progress}%`;
    
    if (warningTime <= 0) {
      clearInterval(warningState.interval);
      warningState.interval = null;
      warningState.active = false;
      
      // Tutup popup peringatan
      popup.style.display = 'none';
      
      // Hentikan audio beep
      if (audioBeep) {
        audioBeep.pause();
        audioBeep.currentTime = 0;
      }
    }
    
    warningTime--;
  }, 1000);
}

function endIqamahCountdown() {
  stopAllAudio();

  document.getElementById('blackOverlay').style.display = 'block';
  document.getElementById('closeBlackOverlay').style.display = 'block';

  ['.media-container', '.adzan-table', '.marquee'].forEach(sel => {
    const el = document.querySelector(sel);
    if (el) {
      el.style.visibility = 'hidden';
      el.style.opacity = '0';
    }
  });
 
  const durasi = overlayBlackDurations[countdownState.prayer] || 15;
  setTimeout(closeBlackOverlay, durasi * 60 * 1000);

      // üî¥ CLEANUP MEMORY
    countdownState.active = false;
    countdownState.type = null;
    countdownState.prayer = null;
    countdownState.remaining = 0;

}

function closeBlackOverlay() {
  document.getElementById('blackOverlay').style.display = 'none';
  document.getElementById('closeBlackOverlay').style.display = 'none';

  ['.media-container', '.adzan-table', '.marquee'].forEach(sel => {
    const el = document.querySelector(sel);
    if (el) {
      el.style.visibility = 'visible';
      el.style.opacity = '1';
    }
  });

  // ‚úÖ RELOAD HALAMAN SETELAH OVERLAY BERAKHIR
  setTimeout(() => {
    location.reload();
  }, 500); // delay kecil biar STB stabil
}