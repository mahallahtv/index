// ==================== UPDATE checkPrayerTimes ====================
// ==================== CEK WAKTU SHOLAT (DENGAN ROOSTER UNTUK IMSAK) ====================
function checkPrayerTimes() {
    const now = new Date();
    const currentTime = now.getHours() * 3600 + now.getMinutes() * 60 + now.getSeconds();
    
    const prayers = ['shubuh', 'dzuhur', 'ashar', 'maghrib', 'isya'];
    
    prayers.forEach(prayer => {
        const timeStr = adzanSchedule[prayer];
        if (!timeStr || timeStr === '--:--') return;
        
        const [h, m] = timeStr.split(':').map(Number);
        const prayerTime = h * 3600 + m * 60;
        
        const countdownMinutes = adzanCountdownDurations[prayer] || 10;
        const triggerTime = prayerTime - (countdownMinutes * 60);
        
        if (currentTime >= triggerTime && currentTime <= triggerTime + 59) {
            if (!countdownState.active) {
                showPopupAdzan(prayer);
            }
        }
    });
    
    // ==================== CEK WAKTU IMSAK UNTUK POPUP ====================
    const imsakStr = adzanSchedule.imsak;
    if (imsakStr && imsakStr !== '--:--') {
        const [ih, im] = imsakStr.split(':').map(Number);
        const imsakTime = ih * 3600 + im * 60;
        
        // Putar rooster tepat pada waktu imsak (dalam toleransi 10 detik)
        if (currentTime >= imsakTime && currentTime <= imsakTime + 10) {
            playRoosterAudio();
        }
        
        // Tampilkan popup Imsak jika tepat waktu
        if (currentTime >= imsakTime && currentTime <= imsakTime + 1) {
            if (!imsakState.active) {
                showPopupImsak();
            }
        }
    }

    // ==================== CEK WAKTU SYURUQ UNTUK POPUP ====================
    const syuruqStr = adzanSchedule.syuruq;
    if (syuruqStr && syuruqStr !== '--:--') {
        const [sh, sm] = syuruqStr.split(':').map(Number);
        const syuruqTime = sh * 3600 + sm * 60;
        
        // Tampilkan popup Syuruq jika tepat waktu
        if (currentTime >= syuruqTime && currentTime <= syuruqTime + 1) {
            if (!syuruqState.active) {
                showPopupSyuruq();
            }
        }
    }
}

// ==================== FUNGSI ROOSTER AUDIO ====================
var roosterPlayedToday = false; // Flag untuk mencegah loop
var lastRoosterDate = null; // Tanggal terakhir rooster diputar

function playRoosterAudio() {
    const today = new Date().toDateString();
    
    // Cek apakah rooster sudah diputar hari ini
    if (lastRoosterDate === today && roosterPlayedToday) {
        return; // Sudah diputar hari ini, jangan putar lagi
    }
    
    const audioRooster = document.getElementById('audioRooster');
    if (audioRooster) {
        // Reset flag jika hari sudah berganti
        if (lastRoosterDate !== today) {
            roosterPlayedToday = false;
            lastRoosterDate = today;
        }
        
        // Jika belum diputar hari ini, putar audio
        if (!roosterPlayedToday) {
            audioRooster.currentTime = 0;
            audioRooster.play().then(() => {
                roosterPlayedToday = true;
                console.log('Rooster audio played for imsak');
            }).catch(e => {
                console.log('Error playing rooster audio:', e);
            });
        }
    }
}

// Reset flag rooster setiap hari (setelah tengah malam)
function resetRoosterFlag() {
    const now = new Date();
    const hours = now.getHours();
    const minutes = now.getMinutes();
    
    // Reset setelah tengah malam (00:00 - 00:10)
    if (hours === 0 && minutes <= 10) {
        roosterPlayedToday = false;
        lastRoosterDate = null;
    }
}

// Panggil resetRoosterFlag setiap menit
setInterval(resetRoosterFlag, 60000);

// ==================== FUNGSI POPUP IMSAK ====================
function showPopupImsak() {
    if (imsakState.active) return;
    
    // Set state aktif
    imsakState.active = true;
    imsakState.beepCount = 15;
    
    // Tampilkan popup di tengah layar
    const popup = document.getElementById('popupImsakOverlay');
    popup.style.display = 'flex';
    popup.style.justifyContent = 'center';
    popup.style.alignItems = 'center';
    
    // Update teks
    document.getElementById('popupImsakText').textContent = 'Waktu Imsak telah Tiba';
    document.getElementById('imsakBeepCounter').textContent = '15';
    
    // Mulai countdown beep
    startImsakBeep();
}

function startImsakBeep() {
    if (imsakState.interval) {
        clearInterval(imsakState.interval);
    }
    
    const beepElement = document.getElementById('imsakBeepCounter');
    const progressElement = document.getElementById('imsakProgress');
    
    // Putar beep pertama kali
    playBeep();
    
    imsakState.interval = setInterval(() => {
        // Kurangi counter
        imsakState.beepCount--;
        
        // Update tampilan
        beepElement.textContent = imsakState.beepCount;
        
        const progress = (imsakState.beepCount / 15) * 100;
        progressElement.style.width = `${progress}%`;
        
        // Putar beep untuk setiap hitungan
        if (imsakState.beepCount > 0) {
            playBeep();
        }
        
        // Selesai setelah 15 beep
        if (imsakState.beepCount <= 0) {
            clearInterval(imsakState.interval);
            imsakState.interval = null;
            imsakState.active = false;
            
            // Tutup popup setelah 2 detik
            setTimeout(() => {
                document.getElementById('popupImsakOverlay').style.display = 'none';
            }, 2000);
        }
    }, 1000); // 1 detik antara beep
}

// ==================== FUNGSI POPUP SYURUQ ====================
function showPopupSyuruq() {
    if (syuruqState.active) return;
    
    // Set state aktif
    syuruqState.active = true;
    syuruqState.beepCount = 15;
    
    // Tampilkan popup di tengah layar
    const popup = document.getElementById('popupSyuruqOverlay');
    popup.style.display = 'flex';
    popup.style.justifyContent = 'center';
    popup.style.alignItems = 'center';
    
    // Update teks
    document.getElementById('popupSyuruqText').textContent = 'Waktu Syuruq telah Tiba';
    document.getElementById('syuruqBeepCounter').textContent = '15';
    
    // Mulai countdown beep
    startSyuruqBeep();
}

function startSyuruqBeep() {
    if (syuruqState.interval) {
        clearInterval(syuruqState.interval);
    }
    
    const beepElement = document.getElementById('syuruqBeepCounter');
    const progressElement = document.getElementById('syuruqProgress');
    
    // Putar beep pertama kali
    playBeep();
    
    syuruqState.interval = setInterval(() => {
        // Kurangi counter
        syuruqState.beepCount--;
        
        // Update tampilan
        beepElement.textContent = syuruqState.beepCount;
        
        const progress = (syuruqState.beepCount / 15) * 100;
        progressElement.style.width = `${progress}%`;
        
        // Putar beep untuk setiap hitungan
        if (syuruqState.beepCount > 0) {
            playBeep();
        }
        
        // Selesai setelah 15 beep
        if (syuruqState.beepCount <= 0) {
            clearInterval(syuruqState.interval);
            syuruqState.interval = null;
            syuruqState.active = false;
            
            // Tutup popup setelah 2 detik
            setTimeout(() => {
                document.getElementById('popupSyuruqOverlay').style.display = 'none';
            }, 2000);
        }
    }, 1000); // 1 detik antara beep
}

// ==================== FUNGSI PLAY BEEP ====================
function playBeep() {
    const audioBeep = document.getElementById('audioBeep');
    if (audioBeep) {
        // Reset audio ke awal
        audioBeep.currentTime = 0;
        
        // Putar audio (non-loop)
        audioBeep.play().catch(e => {
            console.log('Error playing beep:', e);
        });
    }
}

// ==================== EVENT LISTENER UNTUK POPUP ====================
function setupPopupEvents() {
    // Popup Imsak - tutup jika diklik di luar
    const popupImsak = document.getElementById('popupImsakOverlay');
    if (popupImsak) {
        popupImsak.addEventListener('click', function(e) {
            if (e.target === this) {
                stopAllAudio();
                this.style.display = 'none';
            }
        });
    }
    
    // Popup Syuruq - tutup jika diklik di luar
    const popupSyuruq = document.getElementById('popupSyuruqOverlay');
    if (popupSyuruq) {
        popupSyuruq.addEventListener('click', function(e) {
            if (e.target === this) {
                stopAllAudio();
                this.style.display = 'none';
            }
        });
    }
}

// Panggil fungsi setup di init
// Tambahkan ini di window.onload setelah setupSimpleEvents()
setupPopupEvents();

// ==================== CAROUSEL ====================
function initCarousels() {
    // Load slider settings
    loadSliderSettings();

    // Load carousel kiri
    loadLeftCarousel();
    
    // Load carousel kanan
    loadMainCarousel();
    
    // Setup transisi carousel
    setupCarouselTransitions();

        // Nonaktifkan pause behavior pada carousel
    disableCarouselPause();
}

// Fungsi untuk menonaktifkan pause behavior
function disableCarouselPause() {
    // Untuk slide kiri
    var leftCarousel = document.getElementById('leftCarousel');
    if (leftCarousel) {
        // Set attribute untuk mencegah pause
        leftCarousel.setAttribute('data-bs-pause', 'false');
        leftCarousel.setAttribute('data-bs-touch', 'false');
        
        // Setup event listener untuk mencegah pause saat hover/click
        leftCarousel.addEventListener('mouseenter', function(e) {
            e.stopPropagation();
            return false;
        });
        
        leftCarousel.addEventListener('click', function(e) {
            e.stopPropagation();
            return false;
        });
    }
    
    // Untuk slide kanan
    var mainCarousel = document.getElementById('mainCarousel');
    if (mainCarousel) {
        // Set attribute untuk mencegah pause
        mainCarousel.setAttribute('data-bs-pause', 'false');
        mainCarousel.setAttribute('data-bs-touch', 'false');
        
        // Setup event listener untuk mencegah pause saat hover/click
        mainCarousel.addEventListener('mouseenter', function(e) {
            e.stopPropagation();
            return false;
        });
        
        mainCarousel.addEventListener('click', function(e) {
            e.stopPropagation();
            return false;
        });
    }
    
}

// Tambahkan fungsi baru untuk setup transisi
function setupCarouselTransitions() {
    // Setup untuk slide kiri (slide down)
    var leftCarousel = document.getElementById('leftCarousel');
    if (leftCarousel) {
        // Tambahkan class untuk transisi slide down
        var leftCarouselInner = leftCarousel.querySelector('.carousel-inner');
        if (leftCarouselInner) {
            leftCarouselInner.style.overflow = 'hidden';
        }
    }
    
    // Setup untuk slide kanan (opacity)
    var mainCarousel = document.getElementById('mainCarousel');
    if (mainCarousel) {
        // Tambahkan class untuk transisi opacity
        var mainCarouselInner = mainCarousel.querySelector('.carousel-inner');
        if (mainCarouselInner) {
            mainCarouselInner.classList.add('carousel-fade');
        }
    }
}

function loadLeftCarousel() {
    try {
        var inner = document.getElementById('leftCarouselInner');
        if (!inner) return;
        
        // AMBIL HIDDEN SLIDES DARI LISENSI
        var licenseHiddenSlides = [];
        try {
            var hiddenSlidesStr = localStorage.getItem('license_hidden_slides');
            if (hiddenSlidesStr) {
                licenseHiddenSlides = JSON.parse(hiddenSlidesStr);
            }
        } catch (e) {
            console.log('Error reading license hidden slides:', e);
        }
        
        console.log('Slides hidden by license:', licenseHiddenSlides);
        
        // Buat semua slide yang mungkin
        var allSlides = [
            { num: 1, content: createLeftSlide1() },
            { num: 2, content: createLeftSlide2() },
            { num: 3, content: createLeftSlide3() },
            { num: 4, content: createLeftSlide4() }
        ];
        
        // Filter slide yang TIDAK dihidden dan ADA kontennya
        var activeSlides = [];
        for (var i = 0; i < allSlides.length; i++) {
            var slide = allSlides[i];
            
            // Skip jika slide dihidden oleh lisensi
            if (licenseHiddenSlides.includes(slide.num)) {
                console.log('Slide ' + slide.num + ' hidden by license');
                continue;
            }
            
            // Skip jika konten kosong/null
            if (!slide.content || slide.content.trim() === '') {
                console.log('Slide ' + slide.num + ' has no content');
                continue;
            }
            
            activeSlides.push({
                num: slide.num,
                content: slide.content,
                id: 'slide' + slide.num
            });
        }
        
        // Jika tidak ada slide aktif, buat default
        if (activeSlides.length === 0) {
            activeSlides.push({
                num: 0,
                content: '<h5><i class="bi bi-info-circle text-primary"></i> Informasi</h5>' +
                        '<div class="alert alert-warning mt-3">Belum ada konten untuk ditampilkan</div>',
                id: 'default'
            });
        }
        
        // Kosongkan carousel inner
        inner.innerHTML = '';
        
        // Tambahkan hanya slide aktif
        for (var j = 0; j < activeSlides.length; j++) {
            var slide = activeSlides[j];
            var item = document.createElement('div');
            item.className = 'carousel-item' + (j === 0 ? ' active' : '');
            item.id = slide.id;
            item.innerHTML = '<div class="left-card"><div class="card-body">' + 
                           slide.content + '</div></div>';
            inner.appendChild(item);
        }
        
        // Setup carousel berdasarkan jumlah slide
        setupCarouselForSlideCount(activeSlides.length);
        
    } catch (e) {
        console.log('Error loadLeftCarousel:', e);
    }
}

// FUNGSI BARU UNTUK SETUP CAROUSEL
function setupCarouselForSlideCount(slideCount) {
    var leftCarousel = document.getElementById('leftCarousel');
    if (!leftCarousel) return;
    
    // Update indicators
    updateCarouselIndicators(slideCount);
    
    // Jika hanya 1 slide, nonaktifkan carousel
    if (slideCount <= 1) {
        // Nonaktifkan autoplay
        leftCarousel.setAttribute('data-bs-interval', '0');
        
        // Sembunyikan indicators
        var indicators = leftCarousel.querySelector('.carousel-indicators');
        if (indicators) indicators.style.display = 'none';
        
        // Sembunyikan tombol prev/next
        var prevBtn = leftCarousel.querySelector('.carousel-control-prev');
        var nextBtn = leftCarousel.querySelector('.carousel-control-next');
        if (prevBtn) prevBtn.style.display = 'none';
        if (nextBtn) nextBtn.style.display = 'none';
        
        // Nonaktifkan swipe/touch
        leftCarousel.setAttribute('data-bs-touch', 'false');
    } else {
        // Aktifkan carousel
        var interval = 10000; // 10 detik
        leftCarousel.setAttribute('data-bs-interval', interval);
        
        // Tampilkan indicators
        var indicators = leftCarousel.querySelector('.carousel-indicators');
        if (indicators) indicators.style.display = 'flex';
        
        // Tampilkan tombol prev/next
        var prevBtn = leftCarousel.querySelector('.carousel-control-prev');
        var nextBtn = leftCarousel.querySelector('.carousel-control-next');
        if (prevBtn) prevBtn.style.display = 'block';
        if (nextBtn) nextBtn.style.display = 'block';
    }
}

function updateCarouselIndicators(slideCount) {
    try {
        var indicatorsContainer = document.querySelector('#leftCarousel .carousel-indicators');
        if (!indicatorsContainer) {
            // Buat indicators jika belum ada
            var carousel = document.getElementById('leftCarousel');
            if (carousel) {
                indicatorsContainer = document.createElement('div');
                indicatorsContainer.className = 'carousel-indicators';
                carousel.querySelector('.carousel-inner').after(indicatorsContainer);
            }
        }
        
        if (indicatorsContainer) {
            indicatorsContainer.innerHTML = '';
            
            for (var i = 0; i < slideCount; i++) {
                var button = document.createElement('button');
                button.type = 'button';
                button.setAttribute('data-bs-target', '#leftCarousel');
                button.setAttribute('data-bs-slide-to', i);
                button.setAttribute('aria-label', 'Slide ' + (i + 1));
                if (i === 0) {
                    button.className = 'active';
                    button.setAttribute('aria-current', 'true');
                }
                indicatorsContainer.appendChild(button);
            }
        }
    } catch (e) {
        console.log('Error updateCarouselIndicators:', e);
    }
}

function createLeftSlide1() {
    var message = settings.customMessage || 'Selamat datang di Masjid Al-Muthmainnah';
    return '<h5><i class="bi bi-chat-text text-primary"></i> </h5>' +
           '<div style="margin-top: 20px; font-size: 16px; line-height: 1.6;">' +
           message.replace(/\\n/g, '<br>') +
           '</div>';
}

function createLeftSlide2() {
    try {
        if (typeof hariIslamData !== 'undefined') {

            // Pastikan updateHijri sudah dipanggil saat init
            var hijriDate = window.currentHijriDate;

            if (!hijriDate) {
                console.log('Hijri date object belum tersedia');
                return null;
            }

            var messages = hariIslamData.getMessages(hijriDate);

            if (messages && messages.length > 0) {
                var content = '<h5><i class="bi bi-calendar-event text-success"></i> Hari Besar Islam Hari Ini</h5>';
                for (var i = 0; i < messages.length; i++) {
                    content += '<div class="alert alert-success mt-2">' + messages[i] + '</div>';
                }
                return content;
            }

            return null;
        }
    } catch (e) {
        console.log('Error createLeftSlide2:', e);
    }
    return null;
}


function createLeftSlide3() {
    try {
        if (typeof ayatHaditsData !== 'undefined' && ayatHaditsData.length > 0) {
            var randomIndex = Math.floor(Math.random() * ayatHaditsData.length);
            var item = ayatHaditsData[randomIndex];
            
            return '<h5><i class="bi bi-book text-warning"></i> ' + item.jenis + '</h5>' +
                   '<small class="text-muted">Tentang: ' + item.tentang + '</small>' +
                   '<div style="font-size: 16px; text-align: right; direction: rtl; margin-top: 15px;">' +
                   item.isi +
                   '</div>' +
                   '<div style="font-size: 14px; font-style: italic; margin-top: 15px; border-top: 1px solid #eee; padding-top: 10px;">' +
                   '<i class="bi bi-translate text-primary me-2"></i>' + item.terjemahan +
                   '</div>';
        }
    } catch (e) {
        console.log('Error createLeftSlide3:', e);
    }
    return null;
}

function createLeftSlide4() {
    try {
        if (typeof hariIslamData === 'undefined') {
            return null;
        }

        // Ambil langsung object Hijriyah global
        var hijriDate = window.currentHijriDate;

        if (!hijriDate) {
            return null;
        }
        var upcomingEvents = hariIslamData.getUpcomingEvents(hijriDate, 2);

        if (upcomingEvents && upcomingEvents.length > 0) {
            var hijriMonths = [
                'Muharram', 'Safar', 'Rabiul Awal', 'Rabiul Akhir',
                'Jumadil Awal', 'Jumadil Akhir', 'Rajab', 'Sya\'ban',
                'Ramadhan', 'Syawal', 'Dzulqaidah', 'Dzulhijjah'
            ];

            var content = '<h5><i class="bi bi-clock-history text-info"></i> Hari Besar Islam</h5>';

            for (var i = 0; i < upcomingEvents.length; i++) {
                var event = upcomingEvents[i];
                var daysText = event.days === 1 ? 'besok' : event.days + ' hari lagi';
                var monthName = hijriMonths[event.month - 1] || ('Bulan ' + event.month);

                content +=
                    '<div class="alert alert-info mt-2">' +
                        '<div class="fw-bold">' + daysText + '</div>' +
                        '<div>' + event.name + '</div>' +
                        '<small class="text-muted">' +
                            event.day + ' ' + monthName + ' ' + hijriDate.year + ' H' +
                        '</small>' +
                    '</div>';
            }

            return content;
        }

    } catch (e) {
        console.log('Error createLeftSlide4:', e);
    }

    return null;
}


function loadMainCarousel() {
    const carouselInner = document.getElementById('mainCarouselInner');
    carouselInner.innerHTML = '';

    let images = settings.uploadedImages;

    // âœ… JIKA BELUM ADA GAMBAR â†’ DEFAULT
    if (!images || images.length === 0) {
        images = defaultMainImages.map(src => ({ src }));
    }

    images.forEach((item, index) => {
        const carouselItem = document.createElement('div');
        carouselItem.className = 'carousel-item' + (index === 0 ? ' active' : '');

        const img = document.createElement('img');

        // ðŸ”‘ AMBIL SRC YANG BENAR
        img.src = item.data || item.src;

        img.className = 'd-block w-100';
        img.style.objectFit = 'cover';

        carouselItem.appendChild(img);
        carouselInner.appendChild(carouselItem);
    });

}



// ==================== RUNNING TEXT ====================
function initRunningText() {
    updateRunningTextUI();
}

function updateRunningTextUI() {
    var runningText = settings.runningText || 'Mohon untuk Menonaktifkan atau Mode Silent HP Anda jika Iqamah Telah Tiba';
    var display = document.getElementById('runningTextDisplay');
    if (display) {
        display.innerHTML = runningText;
    }
}

// ==================== SETTINGS & FORMS ====================
function loadSettings() {
    try {
        // Load dari localStorage
        var savedSettings = localStorage.getItem('masjidSettings');
        if (savedSettings) {
            settings = JSON.parse(savedSettings);
        }
        
        // Update UI dengan data yang di-load
        document.getElementById('masjidName').textContent = settings.masjidName;
        document.getElementById('masjidAddress').textContent = settings.masjidAddress;
        document.getElementById('namaMasjidInput').value = settings.masjidName;
        document.getElementById('alamatMasjidInput').value = settings.masjidAddress;
        document.getElementById('pesanTeksInput').value = settings.customMessage.replace(/\\n/g, '\n');
        document.getElementById('runningText1').value = settings.runningText;
        document.getElementById('charCount').textContent = (settings.customMessage.length - (settings.customMessage.match(/\\\\n/g) || []).length * 2) + '/300 karakter';
        
        // Load gambar
        updateImagesList();
        
    } catch (e) {
        console.log('Error loadSettings:', e);
    }
}

function saveSettings() {
    try {
        // Simpan ke localStorage
        localStorage.setItem('masjidSettings', JSON.stringify(settings));
        return true;
    } catch (e) {
        return false;
    }
}

function setupSimpleEvents() {
    // Setup form submit untuk STB
    setupFormEvents();
    
    // Setup click events untuk waktu sholat
    setupPrayerClickEvents();
    
    // Setup menu events
    setupMenuEvents();
}

function setupFormEvents() {
    // Form Data Masjid
    var masjidForm = document.getElementById('masjidDataForm');
    if (masjidForm) {
        masjidForm.onsubmit = function(e) {
            e.preventDefault();
            saveMasjidData();
            return false;
        };
    }
    
    // Form Running Text
    var runningTextForm = document.getElementById('runningTextForm');
    if (runningTextForm) {
        runningTextForm.onsubmit = function(e) {
            e.preventDefault();
            saveRunningText();
            return false;
        };
    }
    
    // Form Pesan Teks
    var pesanTeksForm = document.getElementById('pesanTeksForm');
    if (pesanTeksForm) {
        pesanTeksForm.onsubmit = function(e) {
            e.preventDefault();
            savePesanTeks();
            return false;
        };
    }
    
    // Character counter
    var pesanInput = document.getElementById('pesanTeksInput');
    if (pesanInput) {
        pesanInput.oninput = function() {
            var count = this.value.length;
            document.getElementById('charCount').textContent = count + '/300 karakter';
        };
    }
}

function saveMasjidData() {
    settings.masjidName = document.getElementById('namaMasjidInput').value || 'Al-Muthmainnah';
    settings.masjidAddress = document.getElementById('alamatMasjidInput').value || 'Desa Toluwaya, Bulango Timur';
    
    // Handle logo upload
    var logoInput = document.getElementById('logoInput');
    if (logoInput.files.length > 0) {
        var file = logoInput.files[0];
        var reader = new FileReader();
        reader.onload = function(e) {
            settings.logo = e.target.result;
            document.getElementById('masjidLogo').src = e.target.result;
            document.getElementById('logoPreviewImg').src = e.target.result;
            
            if (saveSettings()) {
                alert('Data masjid berhasil disimpan!');
            }
        };
        reader.readAsDataURL(file);
    } else {
        if (saveSettings()) {
            alert('Data masjid berhasil disimpan!');
        }
    }
    
    // Update UI
    document.getElementById('masjidName').textContent = settings.masjidName;
    document.getElementById('masjidAddress').textContent = settings.masjidAddress;
}

function saveRunningText() {
    settings.runningText = document.getElementById('runningText1').value || '';
    
    if (saveSettings()) {
        updateRunningTextUI();
        alert('Running text berhasil disimpan!');
    }
}

function savePesanTeks() {
    var message = document.getElementById('pesanTeksInput').value || '';
    settings.customMessage = message.replace(/\n/g, '\\n');
    
    if (saveSettings()) {
        loadLeftCarousel();
        alert('Pesan teks berhasil disimpan!');
    }
}

function setupPrayerClickEvents() {
  const prayers = ['Imsak', 'Shubuh', 'Syuruq', 'Dzuhur', 'Ashar', 'Maghrib', 'Isya'];
  
  prayers.forEach(prayer => {
    const element = document.getElementById(`time${prayer}`);
    if (element) {
      // Untuk imsak dan syuruq tidak perlu popup, langsung tampilkan modal pengaturan
      if (prayer === 'Imsak' || prayer === 'Syuruq') {
        element.addEventListener('click', () => {
          currentPrayer = prayer.toLowerCase();
          showPrayerSettings(currentPrayer);
        });
      } else {
        // Untuk sholat lainnya, tampilkan modal pengaturan
        element.addEventListener('click', () => {
          currentPrayer = prayer.toLowerCase();
          showPrayerSettings(currentPrayer);
        });
      }
    }
  });
}

function showPrayerSettings(prayer) {
  const prayerNames = {
    imsak: 'Imsak',
    shubuh: 'Shubuh',
    syuruq: 'Syuruq',
    dzuhur: 'Dzuhur',
    ashar: 'Ashar',
    maghrib: 'Maghrib',
    isya: 'Isya'
  };
  
  // Update label modal
  document.getElementById('prayerNameLabel').innerText = `Pengaturan Waktu ${prayerNames[prayer]}`;
  document.getElementById('currentOffset').textContent = `Offset: ${prayerOffsets[prayer] || 0} menit`;
  
  // Tampilkan modal
  const modal = new bootstrap.Modal(document.getElementById('prayerSettingsModal'));
  modal.show();
}

function updatePrayerTimeWithOffset(prayer, offset) {
    const element = document.getElementById(`time${prayer.charAt(0).toUpperCase() + prayer.slice(1)}`);
    if (!element || !adzanSchedule[prayer]) return;
    
    const timeStr = adzanSchedule[prayer];
    const [hours, minutes] = timeStr.split(":").map(Number);
    const date = new Date();
    date.setHours(hours);
    date.setMinutes(minutes + offset);
    
    const newTime = 
        date.getHours().toString().padStart(2, '0') + ':' + 
        date.getMinutes().toString().padStart(2, '0');
    
    element.innerText = newTime;
    adzanSchedule[prayer] = newTime;
}

function createPrayerClickHandler(prayer) {
    return function() {
        currentPrayer = prayer.toLowerCase();
        showPrayerSettings(currentPrayer);
    };
}

function showCountdownForm(type) {
  // Tutup modal utama terlebih dahulu
  const mainModal = bootstrap.Modal.getInstance(document.getElementById('prayerSettingsModal'));
  if (mainModal) mainModal.hide();
  
  let title = '';
  let formHtml = '';
  let headerColor = '';
  
  if (type === 'adzan') {
    title = `Countdown Adzan ${currentPrayer.charAt(0).toUpperCase() + currentPrayer.slice(1)}`;
    headerColor = 'bg-success text-white';
    formHtml = `
      <div class="mb-3">
        <label class="form-label">Durasi Countdown (menit)</label>
        <div class="input-group">
          <input type="number" class="form-control" id="countdownValue" 
                 value="${adzanCountdownDurations[currentPrayer] || 10}" min="1" max="60">
          <span class="input-group-text">menit</span>
        </div>
        <small class="text-muted">Waktu countdown sebelum adzan dimulai</small>
      </div>
    `;
  } else if (type === 'iqamah') {
    title = `Countdown Iqamah ${currentPrayer.charAt(0).toUpperCase() + currentPrayer.slice(1)}`;
    headerColor = 'bg-warning text-white';
    formHtml = `
      <div class="mb-3">
        <label class="form-label">Durasi Iqamah (menit)</label>
        <div class="input-group">
          <input type="number" class="form-control" id="countdownValue" 
                 value="${iqamahCountdownDurations[currentPrayer] || 25}" min="1" max="120">
          <span class="input-group-text">menit</span>
        </div>
        <small class="text-muted">Waktu menunggu antara adzan dan iqamah</small>
      </div>
    `;
  } else if (type === 'overlay') {
    title = `Durasi Overlay ${currentPrayer.charAt(0).toUpperCase() + currentPrayer.slice(1)}`;
    headerColor = 'bg-dark text-white';
    formHtml = `
      <div class="mb-3">
        <label class="form-label">Durasi Overlay Hitam (menit)</label>
        <div class="input-group">
          <input type="number" class="form-control" id="countdownValue" 
                 value="${overlayBlackDurations[currentPrayer] || 15}" min="1" max="180">
          <span class="input-group-text">menit</span>
        </div>
        <small class="text-muted">Durasi tampilan layar hitam setelah iqamah</small>
      </div>
    `;
  }
  
  // Tambahkan tombol aksi
  formHtml += `
    <div class="d-grid gap-2 mt-4">
      <button class="btn btn-primary" onclick="saveCountdownSettings('${type}')">
        <i class="bi bi-save me-2"></i>Simpan Pengaturan
      </button>
      <button class="btn btn-secondary" onclick="backToMainSettings()">
        <i class="bi bi-arrow-left me-2"></i>Kembali
      </button>
    </div>
  `;
  
  // Update modal form countdown
  document.getElementById('countdownTitle').innerText = title;
  document.getElementById('countdownModalHeader').className = `modal-header ${headerColor}`;
  document.getElementById('countdownFormBody').innerHTML = formHtml;
  
  // Tampilkan modal form
  const formModal = new bootstrap.Modal(document.getElementById('countdownFormModal'));
  formModal.show();
}

function saveCountdownSettings(type) {
  const input = document.getElementById('countdownValue');
  if (!input) return;
  
  const value = parseInt(input.value);
  if (!value || value < 1) {
    showToast('âš ï¸ Masukkan nilai yang valid!', 'warning');
    return;
  }
  
  if (type === 'adzan') {
    adzanCountdownDurations[currentPrayer] = value;
    localStorage.setItem('adzanCountdownDurations', JSON.stringify(adzanCountdownDurations));
    showToast('âœ… Countdown Adzan disimpan!', 'success');
  } else if (type === 'iqamah') {
    iqamahCountdownDurations[currentPrayer] = value;
    localStorage.setItem('iqamahCountdownDurations', JSON.stringify(iqamahCountdownDurations));
    showToast('âœ… Countdown Iqamah disimpan!', 'success');
  } else if (type === 'overlay') {
    overlayBlackDurations[currentPrayer] = value;
    localStorage.setItem('overlayBlackDurations', JSON.stringify(overlayBlackDurations));
    showToast('âœ… Durasi Overlay disimpan!', 'success');
  }
  
  // Tutup modal form
  const formModal = bootstrap.Modal.getInstance(document.getElementById('countdownFormModal'));
  if (formModal) formModal.hide();
  
  // Kembali ke modal utama
  setTimeout(() => {
    const mainModal = new bootstrap.Modal(document.getElementById('prayerSettingsModal'));
    mainModal.show();
  }, 300);
}

function backToMainSettings() {
  // Tutup modal form
  const formModal = bootstrap.Modal.getInstance(document.getElementById('countdownFormModal'));
  if (formModal) formModal.hide();
  
  // Tampilkan kembali modal utama
  setTimeout(() => {
    const mainModal = new bootstrap.Modal(document.getElementById('prayerSettingsModal'));
    mainModal.show();
  }, 300);
}


function setupMenuEvents() {
    // Close black overlay
    var closeBtn = document.getElementById('closeBlackOverlay');
    if (closeBtn) {
        closeBtn.onclick = function() {
            document.getElementById('blackOverlay').style.display = 'none';
            
            // Tampilkan kembali elemen
            const adzanTable = document.querySelector('.adzan-table');
            const marquee = document.querySelector('.marquee');
            
            if (adzanTable) adzanTable.style.display = 'block';
            if (marquee) marquee.style.display = 'block';
            
            // Clear interval jika ada
            if (blackOverlayInterval) {
                clearTimeout(blackOverlayInterval);
                blackOverlayInterval = null;
            }
        };
    }
    
    // Reset masjid data
    var resetBtn = document.getElementById('resetMasjidData');
    if (resetBtn) {
        resetBtn.onclick = function() {
            if (confirm('Reset data masjid ke default?')) {
                settings.masjidName = 'Al-Muthmainnah';
                settings.masjidAddress = 'Desa Toluwaya, Bulango Timur';
                settings.runningText = 'Mohon untuk Menonaktifkan atau Mode Silent HP Anda jika Iqamah Telah Tiba, Agar tidak mengganggu kekhusyukan Shalat';
                settings.customMessage = 'Selamat datang di Masjid Al-Muthmainnah\\n\\nMari bersama menjaga kebersihan dan ketertiban masjid untuk kenyamanan beribadah kita semua.';
                settings.uploadedImages = [];
                
                if (saveSettings()) {
                    loadSettings();
                    loadLeftCarousel();
                    loadMainCarousel();
                    updateRunningTextUI();
                    alert('Data berhasil direset!');
                }
            }
        };
    }
    
    // Close popup dengan klik di luar
    const popups = ['popupAdzanOverlay', 'iqamahPopupOverlay'];
    popups.forEach(popupId => {
        const popup = document.getElementById(popupId);
        if (popup) {
            popup.addEventListener('click', function(e) {
                if (e.target === this) {
                    this.style.display = 'none';
                    
                    // Clear intervals
                    if (popupId === 'popupAdzanOverlay' && adzanCountdownInterval) {
                        clearInterval(adzanCountdownInterval);
                        adzanCountdownInterval = null;
                        popupAdzanActive = false;
                    }
                    if (popupId === 'iqamahPopupOverlay' && iqamahCountdownInterval) {
                        clearInterval(iqamahCountdownInterval);
                        iqamahCountdownInterval = null;
                        popupIqamahActive = false;
                    }
                }
            });
        }
    });
}

// ==================== FUNGSI OFFSET WAKTU MANUAL ====================
// Ganti fungsi adjustOffset():
function adjustOffset(amount) {
  if (!currentPrayer) return;

  // Pastikan offset ada
  if (typeof prayerOffsets[currentPrayer] !== 'number') {
    prayerOffsets[currentPrayer] = 0;
  }

  // Reset atau tambah/kurang
  if (amount === 0) {
    prayerOffsets[currentPrayer] = 0;
  } else {
    prayerOffsets[currentPrayer] += amount;
  }

  // Batasi offset -60 s/d +60 menit
  prayerOffsets[currentPrayer] = Math.max(
    -60,
    Math.min(60, prayerOffsets[currentPrayer])
  );

  // ðŸ”´ HITUNG ULANG DARI JAM ASLI (BUKAN DARI JAM YANG SUDAH BERGESER)
  const baseTime = originalPrayerTimes[currentPrayer];
  adzanSchedule[currentPrayer] = addMinutes(
    baseTime,
    prayerOffsets[currentPrayer]
  );

  // Update UI
  document.getElementById('currentOffset').textContent =
    `Offset: ${prayerOffsets[currentPrayer]} menit`;

  updatePrayerTimesUI();

  // ðŸ”´ SIMPAN HANYA OFFSET (INI KUNCI AGAR RELOAD TIDAK RUSAK)
  localStorage.setItem('prayerOffsets', JSON.stringify(prayerOffsets));

  // Toast
  const message =
    amount === 0
      ? 'Offset direset ke 0'
      : `Offset diubah ${amount > 0 ? '+' : ''}${amount} menit`;

  showToast(`âœ… ${message}`, 'success');
}

// ==================== LOAD OFFSET DARI LOCALSTORAGE ====================
function loadPrayerOffsets() {
  try {
    const savedOffsets = localStorage.getItem('prayerOffsets');
    if (savedOffsets) {
      prayerOffsets = JSON.parse(savedOffsets);
    } else {
      prayerOffsets = {
        imsak: 0,
        shubuh: 0,
        syuruq: 0,
        dzuhur: 0,
        ashar: 0,
        maghrib: 0,
        isya: 0
      };
    }
    
    // Load manual times if exists
    const savedManualTimes = localStorage.getItem('manualPrayerTimes');
    if (savedManualTimes) {
      adzanSchedule = JSON.parse(savedManualTimes);
      
      // ðŸ”´ PERUBAHAN: Update UI untuk semua sholat yang ada di schedule
      const prayers = ['imsak', 'shubuh', 'syuruq', 'dzuhur', 'ashar', 'maghrib', 'isya'];
      prayers.forEach(prayer => {
        if (adzanSchedule[prayer]) {
          const element = document.getElementById(`time${prayer.charAt(0).toUpperCase() + prayer.slice(1)}`);
          if (element) {
            element.textContent = adzanSchedule[prayer];
          }
        }
      });
    }
    
  } catch (e) {
    console.log('Error loading prayer offsets:', e);
  }
}



function stopAllAudio() {
    try {
        const audioElements = [
            'audioShalawat',
            'audioAdzan', 
            'audioBeep',
            'audioRooster'
        ];
        
        audioElements.forEach(id => {
            const audio = document.getElementById(id);
            if (audio) {
                audio.pause();
                audio.currentTime = 0;
                audio.loop = false;
            }
        });

        // Hentikan interval Imsak dan Syuruq jika aktif
        if (imsakState.interval) {
            clearInterval(imsakState.interval);
            imsakState.interval = null;
            imsakState.active = false;
        }
        
        if (syuruqState.interval) {
            clearInterval(syuruqState.interval);
            syuruqState.interval = null;
            syuruqState.active = false;
        }
        
        // Reset flag rooster jika audio dihentikan paksa
        if (countdownState.prayer === 'imsak') {
            roosterPlayedToday = false;
        }
        
        // Tutup popup Imsak dan Syuruq jika terbuka
        document.getElementById('popupImsakOverlay').style.display = 'none';
        document.getElementById('popupSyuruqOverlay').style.display = 'none';
        
    } catch (e) {
        console.log('Error stopAllAudio:', e);
    }
}

function showToast(message, type = 'info') {
    try {
        // Remove existing toasts
        const existingToasts = document.querySelectorAll('.toast-notification');
        existingToasts.forEach(toast => toast.remove());
        
        const colors = {
            success: '#28a745',
            warning: '#ffc107',
            danger: '#dc3545',
            info: '#17a2b8'
        };
        
        const icons = {
            success: 'bi-check-circle',
            warning: 'bi-exclamation-triangle',
            danger: 'bi-x-circle',
            info: 'bi-info-circle'
        };
        
        const toast = document.createElement('div');
        toast.className = 'toast-notification';
        toast.style.backgroundColor = colors[type] || colors.info;
        toast.style.color = 'white';
        toast.style.border = 'none';
        toast.style.padding = '15px';
        toast.style.borderRadius = '5px';
        toast.innerHTML = `
            <div class="d-flex align-items-center">
                <i class="bi ${icons[type]} me-2" style="font-size: 1.2rem;"></i>
                <div>${message}</div>
            </div>
        `;
        
        document.body.appendChild(toast);
        
        // Auto remove after 3 seconds
        setTimeout(() => {
            if (toast.parentNode) {
                toast.remove();
            }
        }, 3000);
    } catch (e) {
        console.log('Error showToast:', e);
    }
}

// ==================== UPLOAD GAMBAR ====================
function uploadImages() {
    var input = document.getElementById('imageUpload');
    if (!input.files.length) {
        alert('Pilih gambar terlebih dahulu!');
        return;
    }
    
    // Batasi maksimal 5 gambar
    if (settings.uploadedImages.length + input.files.length > 5) {
        alert('Maksimal 5 gambar!');
        return;
    }
    
    var files = input.files;
    var uploadedCount = 0;
    
    for (var i = 0; i < files.length; i++) {
        var file = files[i];
        
        // Batasi ukuran (1MB)
        if (file.size > 1024 * 1024) {
            alert('Gambar ' + file.name + ' terlalu besar (maks 1MB)');
            continue;
        }
        
        var reader = new FileReader();
        reader.onload = (function(file) {
            return function(e) {
                settings.uploadedImages.push({
                    name: file.name,
                    data: e.target.result,
                    timestamp: new Date().getTime()
                });
                
                uploadedCount++;
                
                if (uploadedCount === files.length) {
                    if (saveSettings()) {
                        updateImagesList();
                        loadMainCarousel();
                        input.value = '';
                        alert('Gambar berhasil diupload!');
                    }
                }
            };
        })(file);
        
        reader.readAsDataURL(file);
    }
}

function updateImagesList() {
    var container = document.getElementById('imagesContainer');
    if (!container) return;
    
    container.innerHTML = '';
    
    if (!settings.uploadedImages || settings.uploadedImages.length === 0) {
        container.innerHTML = '<p class="text-muted text-center">Belum ada gambar</p>';
        return;
    }
    
    for (var i = 0; i < settings.uploadedImages.length; i++) {
        var img = settings.uploadedImages[i];
        var col = document.createElement('div');
        col.className = 'col-6 mb-3';
        col.innerHTML = '<div class="card image-preview">' +
                       '<img src="' + img.data + '" class="card-img-top" style="height: 100px; object-fit: cover;">' +
                       '<div class="card-body p-2">' +
                       '<small class="d-block text-truncate mb-1">' + img.name + '</small>' +
                       '<button class="btn btn-sm btn-danger w-100" onclick="deleteImage(' + i + ')">' +
                       '<i class="bi bi-trash"></i> Hapus</button></div></div>';
        container.appendChild(col);
    }
}

function deleteImage(index) {
    if (confirm('Hapus gambar ini?')) {
        settings.uploadedImages.splice(index, 1);
        if (saveSettings()) {
            updateImagesList();
            loadMainCarousel();
            alert('Gambar berhasil dihapus!');
        }
    }
}

// ==================== LISENSI APLIKASI ====================
function updateLicenseInfo() {
    try {
        var now = new Date();
        var expiry = new Date(settings.license.expiry);
        var daysLeft = Math.ceil((expiry - now) / (1000 * 60 * 60 * 24));
        
        document.getElementById('licensePackage').textContent = settings.license.package;
        document.getElementById('licenseExpiryDate').textContent = expiry.toLocaleDateString('id-ID');
        document.getElementById('licenseDaysLeft').textContent = daysLeft > 0 ? daysLeft : 0;
        
        if (daysLeft > 7) {
            document.getElementById('licenseStatusText').className = 'badge bg-success';
            document.getElementById('licenseStatusText').textContent = 'Aktif';
        } else if (daysLeft > 0) {
            document.getElementById('licenseStatusText').className = 'badge bg-warning';
            document.getElementById('licenseStatusText').textContent = 'Hampir Habis';
        } else {
            document.getElementById('licenseStatusText').className = 'badge bg-danger';
            document.getElementById('licenseStatusText').textContent = 'Kadaluarsa';
            
            // Tampilkan modal lisensi jika kadaluarsa
            setTimeout(function() {
                var modal = new bootstrap.Modal(document.getElementById('licenseModal'));
                modal.show();
            }, 1000);
        }
        
        var progress = Math.max(0, Math.min(100, (30 - daysLeft) / 30 * 100));
        document.getElementById('licenseProgressBar').style.width = progress + '%';
        document.getElementById('licenseProgressText').textContent = Math.round(progress) + '% digunakan';
        
    } catch (e) {
        console.log('Error updateLicenseInfo:', e);
    }
}

// ==================== PENGATURAN DURASI SLIDER ====================

// Mapping nilai ke durasi (dalam detik)
var sliderDurationMap = {
    0: 10,   // Nilai 0 = 10 detik
    1: 15,   // Nilai 1 = 15 detik (+5)
    2: 20,   // Nilai 2 = 20 detik (+10) 
    3: 25,   // Nilai 3 = 25 detik (+15)
    4: 30,   // Nilai 4 = 30 detik (+20)
    5: 40    // Nilai 5 = 40 detik (+30)
};

// Default duration index (bukan detik langsung)
var sliderSettings = {
    leftCarousel: 0,  // Index 0 = 10 detik
    mainCarousel: 0   // Index 0 = 10 detik
};

// Fungsi untuk mendapatkan durasi dari index
function getDurationFromIndex(index) {
    return sliderDurationMap[index] || 10;
}

// Load settings dari localStorage
function loadSliderSettings() {
    try {
        var saved = localStorage.getItem('sliderSettings');
        if (saved) {
            var parsed = JSON.parse(saved);
            sliderSettings.leftCarousel = parsed.leftCarousel || 0;
            sliderSettings.mainCarousel = parsed.mainCarousel || 0;
            
            // Update carousel intervals
            updateCarouselIntervals();
        }
    } catch (e) {
        console.log('Error loadSliderSettings:', e);
    }
}

// Update interval carousel berdasarkan settings
function updateCarouselIntervals() {
    try {
        // Convert durasi dari index ke milidetik
        var leftDuration = getDurationFromIndex(sliderSettings.leftCarousel);
        var mainDuration = getDurationFromIndex(sliderSettings.mainCarousel);
        
        var leftInterval = leftDuration * 1000;
        var mainInterval = mainDuration * 1000;
        
        // Update left carousel
        var leftCarousel = document.getElementById('leftCarousel');
        if (leftCarousel) {
            leftCarousel.setAttribute('data-bs-interval', leftInterval);
            
            // Jika carousel sudah diinisialisasi, update interval-nya
            var leftCarouselInstance = bootstrap.Carousel.getInstance(leftCarousel);
            if (leftCarouselInstance) {
                leftCarouselInstance._config.interval = leftInterval;
            }
        }
        
        // Update main carousel
        var mainCarousel = document.getElementById('mainCarousel');
        if (mainCarousel) {
            mainCarousel.setAttribute('data-bs-interval', mainInterval);
            
            // Jika carousel sudah diinisialisasi, update interval-nya
            var mainCarouselInstance = bootstrap.Carousel.getInstance(mainCarousel);
            if (mainCarouselInstance) {
                mainCarouselInstance._config.interval = mainInterval;
            }
        }
        

    } catch (e) {
        console.log('Error updateCarouselIntervals:', e);
    }
}

// Update form pengaturan durasi slider
function showSliderSettingsForm() {
    // Tutup offcanvas menu terlebih dahulu
    var offcanvas = bootstrap.Offcanvas.getInstance(document.getElementById('mainOffcanvasMenu'));
    if (offcanvas) {
        offcanvas.hide();
    }
    
    var leftDuration = getDurationFromIndex(sliderSettings.leftCarousel);
    var mainDuration = getDurationFromIndex(sliderSettings.mainCarousel);
    
    var formHTML = `
        <form id="sliderSettingsForm">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="bi bi-sliders me-2"></i>Pengaturan Durasi Slider</h5>
                </div>
                <div class="card-body">
                    <div class="mb-4">
                        <label class="form-label fw-bold">
                            <i class="bi bi-arrow-left-right me-2 text-primary"></i>
                            Slide Kiri (Pesan, Ayat, Hari Besar)
                        </label>
                        <div class="d-flex align-items-center justify-content-center">
                            <button type="button" class="btn btn-outline-primary btn-lg" onclick="adjustSliderDuration('left', -1)">
                                <i class="bi bi-dash-lg"></i>
                            </button>
                            <div class="mx-3 text-center" style="min-width: 120px;">
                                <div id="leftDurationValue" class="display-6">${sliderSettings.leftCarousel}</div>
                                <small class="text-muted">Nilai (0-5)</small>
                            </div>
                            <button type="button" class="btn btn-outline-primary btn-lg" onclick="adjustSliderDuration('left', 1)">
                                <i class="bi bi-plus-lg"></i>
                            </button>
                        </div>
                        <div class="mt-2 text-center">
                            <div class="badge bg-info p-2">
                                <i class="bi bi-clock me-1"></i>
                                Durasi: <span id="leftActualDuration">${leftDuration}</span> detik
                            </div>
                        </div>
                    </div>
                    
                    <hr>
                    
                    <div class="mb-4">
                        <label class="form-label fw-bold">
                            <i class="bi bi-images me-2 text-success"></i>
                            Slide Gambar (Kanan)
                        </label>
                        <div class="d-flex align-items-center justify-content-center">
                            <button type="button" class="btn btn-outline-success btn-lg" onclick="adjustSliderDuration('main', -1)">
                                <i class="bi bi-dash-lg"></i>
                            </button>
                            <div class="mx-3 text-center" style="min-width: 120px;">
                                <div id="mainDurationValue" class="display-6">${sliderSettings.mainCarousel}</div>
                                <small class="text-muted">Nilai (0-5)</small>
                            </div>
                            <button type="button" class="btn btn-outline-success btn-lg" onclick="adjustSliderDuration('main', 1)">
                                <i class="bi bi-plus-lg"></i>
                            </button>
                        </div>
                        <div class="mt-2 text-center">
                            <div class="badge bg-info p-2">
                                <i class="bi bi-clock me-1"></i>
                                Durasi: <span id="mainActualDuration">${mainDuration}</span> detik
                            </div>
                        </div>
                    </div>
                    
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle me-2"></i>
                        <strong>Konversi Nilai ke Durasi:</strong><br>
                        0 = 10 detik (default)<br>
                        1 = 15 detik (+5)<br>
                        2 = 20 detik (+10)<br>
                        3 = 25 detik (+15)<br>
                        4 = 30 detik (+20)<br>
                        5 = 40 detik (+30)
                    </div>
                    
                    <div class="d-grid gap-2 mt-4">
                        <button type="button" class="btn btn-warning" onclick="resetSliderSettings()">
                            <i class="bi bi-arrow-clockwise me-2"></i>Reset ke Default
                        </button>
                        <button type="button" class="btn btn-primary" onclick="saveSliderSettings()">
                            <i class="bi bi-check-circle me-2"></i>Simpan
                        </button>
                    </div>
                </div>
            </div>
        </form>
    `;
    
    document.getElementById('countdownFormBody').innerHTML = formHTML;
    document.getElementById('countdownTitle').textContent = 'Durasi Slider';
    document.getElementById('countdownModalHeader').className = 'modal-header bg-primary text-white';
    
    var modal = new bootstrap.Modal(document.getElementById('countdownFormModal'));
    modal.show();
}

// Fungsi untuk mengatur durasi slider
function adjustSliderDuration(type, change) {
    var currentValue;
    var valueElement;
    var actualElement;
    
    if (type === 'left') {
        currentValue = sliderSettings.leftCarousel;
        valueElement = 'leftDurationValue';
        actualElement = 'leftActualDuration';
    } else {
        currentValue = sliderSettings.mainCarousel;
        valueElement = 'mainDurationValue';
        actualElement = 'mainActualDuration';
    }
    
    // Batasi nilai 0-5
    var newValue = currentValue + change;
    if (newValue < 0) newValue = 0;
    if (newValue > 5) newValue = 5;
    
    // Update nilai
    if (type === 'left') {
        sliderSettings.leftCarousel = newValue;
    } else {
        sliderSettings.mainCarousel = newValue;
    }
    
    // Update tampilan
    var newDuration = getDurationFromIndex(newValue);
    document.getElementById(valueElement).textContent = newValue;
    document.getElementById(actualElement).textContent = newDuration;
    
    // Update langsung tanpa perlu save dulu (preview)
    updateCarouselIntervals();
}

// Reset ke default
function resetSliderSettings() {
    sliderSettings.leftCarousel = 0;
    sliderSettings.mainCarousel = 0;
    
    // Update tampilan
    document.getElementById('leftDurationValue').textContent = '0';
    document.getElementById('mainDurationValue').textContent = '0';
    document.getElementById('leftActualDuration').textContent = '10';
    document.getElementById('mainActualDuration').textContent = '10';
    
    // Update carousel
    updateCarouselIntervals();
    
    // Tidak langsung simpan, hanya preview
    showSimpleNotification('Durasi direset ke default (10 detik)', 'info');
}

// Simpan settings
function saveSliderSettings() {
    if (saveSliderSettingsToStorage()) {
        var modal = bootstrap.Modal.getInstance(document.getElementById('countdownFormModal'));
        if (modal) modal.hide();
        showSimpleNotification('Pengaturan durasi slider berhasil disimpan!', 'success');
    } else {
        showSimpleNotification('Gagal menyimpan pengaturan!', 'error');
    }
}

function saveSliderSettingsToStorage() {
    try {
        localStorage.setItem('sliderSettings', JSON.stringify(sliderSettings));
        return true;
    } catch (e) {
        console.log('Error saveSliderSettingsToStorage:', e);
        return false;
    }
}

//////AKHIR FUNGSI PENGATURAN SLIDER////////////

// ==================== LOAD COUNTDOWN SETTINGS ====================
function loadCountdownSettings() {
    try {
        // Load dari localStorage atau gunakan default
        var savedAdzanDurations = localStorage.getItem('adzanCountdownDurations');
        var savedIqamahDurations = localStorage.getItem('iqamahCountdownDurations');
        var savedOverlayDurations = localStorage.getItem('overlayBlackDurations');
        var savedPrayerOffsets = localStorage.getItem('prayerOffsets');
        
        // Default values untuk countdown adzan (menit)
        var defaultAdzan = {
            imsak: 10, shubuh: 10, syuruq: 10, dzuhur: 10, ashar: 10, maghrib: 10, isya: 10
        };
        
        // Default values untuk countdown iqamah (menit)
        var defaultIqamah = {
            imsak: 0, shubuh: 25, syuruq: 0, dzuhur: 25, ashar: 25, maghrib: 3, isya: 25
        };
        
        // Default values untuk overlay (menit)
        var defaultOverlay = {
            imsak: 0, shubuh: 15, syuruq: 0, dzuhur: 15, ashar: 15, maghrib: 15, isya: 60
        };
        
        // Load atau gunakan default
        adzanCountdownDurations = savedAdzanDurations ? JSON.parse(savedAdzanDurations) : defaultAdzan;
        iqamahCountdownDurations = savedIqamahDurations ? JSON.parse(savedIqamahDurations) : defaultIqamah;
        overlayBlackDurations = savedOverlayDurations ? JSON.parse(savedOverlayDurations) : defaultOverlay;
        prayerOffsets = savedPrayerOffsets ? JSON.parse(savedPrayerOffsets) : {};
        
        // Inisialisasi nilai 0 untuk prayerOffsets jika belum ada
        var prayers = ['imsak', 'shubuh', 'syuruq', 'dzuhur', 'ashar', 'maghrib', 'isya'];
        prayers.forEach(prayer => {
            if (prayerOffsets[prayer] === undefined) {
                prayerOffsets[prayer] = 0;
            }
        });
        

        
    } catch (e) {
        console.log('Error loadCountdownSettings:', e);
        
        // Gunakan default values jika error
        adzanCountdownDurations = {
            imsak: 10, shubuh: 10, syuruq: 10, dzuhur: 10, ashar: 10, maghrib: 10, isya: 10
        };
        iqamahCountdownDurations = {
            imsak: 0, shubuh: 25, syuruq: 0, dzuhur: 25, ashar: 25, maghrib: 3, isya: 25
        };
        overlayBlackDurations = {
            imsak: 0, shubuh: 15, syuruq: 0, dzuhur: 15, ashar: 15, maghrib: 15, isya: 60
        };
        prayerOffsets = {
            imsak: 0, shubuh: 0, syuruq: 0, dzuhur: 0, ashar: 0, maghrib: 0, isya: 0
        };
    }
}

// Fungsi untuk menampilkan notifikasi sederhana (STB compatible)
function showSimpleNotification(message, type) {
    var notification = document.createElement('div');
    notification.className = 'position-fixed top-0 end-0 m-3 p-3 rounded shadow';
    
    if (type === 'success') {
        notification.style.backgroundColor = '#d1e7dd';
        notification.style.color = '#0f5132';
        notification.style.border = '1px solid #badbcc';
    } else {
        notification.style.backgroundColor = '#f8d7da';
        notification.style.color = '#842029';
        notification.style.border = '1px solid #f5c2c7';
    }
    
    notification.innerHTML = '<i class="bi bi-info-circle me-2"></i>' + message;
    notification.style.zIndex = '99999';
    
    document.body.appendChild(notification);
    
    // Hapus setelah 3 detik
    setTimeout(function() {
        if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
        }
    }, 3000);
}

// ==================== KEYBOARD NAVIGATION UNTUK STB ====================
document.onkeydown = function(e) {
    e = e || window.event;
    var key = e.keyCode || e.which;
    
    switch(key) {
        case 13: // Enter/OK
            var activeElement = document.activeElement;
            if (activeElement && activeElement.click) {
                activeElement.click();
            }
            break;
            
        case 27: // Escape
            // Tutup semua modal dan offcanvas
            var modals = document.querySelectorAll('.modal.show, .offcanvas.show');
            for (var i = 0; i < modals.length; i++) {
                var modal = bootstrap.Modal.getInstance(modals[i]);
                var offcanvas = bootstrap.Offcanvas.getInstance(modals[i]);
                
                if (modal) modal.hide();
                if (offcanvas) offcanvas.hide();
            }
            break;
            
        case 112: // F1 - Settings
            document.getElementById('settingsBtn').click();
            break;
            
        case 37: // Left arrow
            var prevBtn = document.querySelector('.carousel-control-prev');
            if (prevBtn) prevBtn.click();
            break;
            
        case 39: // Right arrow
            var nextBtn = document.querySelector('.carousel-control-next');
            if (nextBtn) nextBtn.click();
            break;
    }
};

// ==================== STB OPTIMIZATION ====================
if (navigator.userAgent.toLowerCase().includes('stb') || !('ontouchstart' in window)) {
    
    // Disable heavy animations, tapi pertahankan transisi carousel sederhana
    var style = document.createElement('style');
    style.textContent = 
        '.carousel-item { transition: none !important; } ' +
        '#leftCarousel .carousel-inner .carousel-item { transition: transform 0.8s ease-in-out !important; } ' +
        '#mainCarousel .carousel-inner .carousel-item { transition: opacity 0.8s ease-in-out !important; } ' +
        // Nonaktifkan pointer events pada carousel items
        '#leftCarousel .carousel-item, ' +
        '#mainCarousel .carousel-item { pointer-events: none !important; } ' +
        '#leftCarousel .carousel-item .left-card, ' +
        '#mainCarousel .carousel-item img { pointer-events: none !important; } ' +
        // Biarkan indicators tetap bisa diklik
        '#leftCarousel .carousel-indicators button, ' +
        '#mainCarousel .carousel-indicators button { pointer-events: auto !important; cursor: pointer !important; }';
    document.head.appendChild(style);
    
    // Load slider settings untuk STB
    loadSliderSettings();
    
    // Setup transisi dan disable pause
    setTimeout(function() {
        setupCarouselTransitions();
        disableCarouselPause();
    }, 1000);
}